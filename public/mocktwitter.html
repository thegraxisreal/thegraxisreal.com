TWITTER 
<!DOCTYPE h>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Twitter</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    /* Base and layout */
    :root {
      --twitter-blue: #1da1f2;
      --twitter-black: #14171a;
      --twitter-dark-gray: #657786;
      --twitter-light-gray: #aab8c2;
      --twitter-extra-light-gray: #e1e8ed;
      --twitter-background: #f5f8fa;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--twitter-background);
      margin: 0;
      padding: 0;
      color: var(--twitter-black);
    }
    .container.main-container {
      margin-top: 20px;
      max-width: 1200px;
    }
    
    /* Navigation */
    nav.navbar {
      background-color: #fff;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    nav.navbar .navbar-brand {
      font-weight: bold;
      color: var(--twitter-blue);
      font-size: 1.5rem;
    }
    
    /* Sidebar */
    .sidebar {
      padding: 0;
      position: sticky;
      top: 70px;
    }
    .sidebar .nav-link {
      padding: 12px 15px;
      color: var(--twitter-black);
      font-weight: 500;
      font-size: 1.1rem;
      border-radius: 30px;
      margin-bottom: 5px;
      display: flex;
      align-items: center;
    }
    .sidebar .nav-link i {
      margin-right: 15px;
      font-size: 1.3rem;
      width: 24px;
      text-align: center;
    }
    .sidebar .nav-link:hover {
      background-color: rgba(29, 161, 242, 0.1);
      color: var(--twitter-blue);
      text-decoration: none;
    }
    
    /* Forms and sections */
    .auth-form,
    .tweet-form,
    .tweet-feed,
    #profileSection,
    #premiumSection,
    #userProfileSection,
    #adminSection {
      background: #fff;
      border-radius: 15px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 20px;
    }
    .auth-form h2,
    .tweet-form h2,
    #premiumSection h2,
    #profileSection h2,
    #userProfileSection h2,
    #adminSection h2 {
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: 15px;
    }
    input.form-control,
    textarea.form-control {
      border: 1px solid var(--twitter-extra-light-gray);
      border-radius: 4px;
      padding: 12px;
      font-size: 1rem;
    }
    textarea.form-control:focus {
      box-shadow: none;
      border-color: var(--twitter-blue);
    }
    button.btn {
      background-color: var(--twitter-blue);
      color: #fff;
      border: none;
      padding: 8px 20px;
      font-size: 1rem;
      border-radius: 30px;
      cursor: pointer;
      font-weight: 600;
    }
    button.btn:hover {
      background-color: #1a91da;
    }
    
    /* Tweet styles */
    .tweet {
      border-bottom: 1px solid var(--twitter-extra-light-gray);
      padding: 15px 0;
    }
    .tweet:last-child {
      border-bottom: none;
    }
    .tweet-header {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    .tweet-profile-pic {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      margin-right: 12px;
      object-fit: cover;
    }
    .default-profile-pic {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      margin-right: 12px;
      background-color: var(--twitter-light-gray);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .default-profile-pic i {
      font-size: 24px;
      color: white;
    }
    .tweet-username {
      font-weight: bold;
      margin-right: 5px;
      cursor: pointer;
      color: var(--twitter-black);
    }
    .tweet-username:hover {
      text-decoration: underline;
    }
    .tweet-timestamp {
      font-size: 0.85rem;
      color: var(--twitter-dark-gray);
    }
    .tweet-text {
      margin: 5px 0 12px 0;
      line-height: 1.4;
      font-size: 1rem;
    }
    .tweet-text .mention, 
    .tweet-text .hashtag {
      color: var(--twitter-blue);
      font-weight: 500;
    }
    .tweet-actions {
      display: flex;
      justify-content: space-between;
      width: 100%;
      margin-top: 10px;
    }
    .action-btn {
      display: flex;
      align-items: center;
      gap: 4px;
      background: none;
      border: none;
      font-size: 0.9rem;
      cursor: pointer;
      color: var(--twitter-dark-gray);
      transition: all 0.2s;
      padding: 8px;
      border-radius: 50%;
    }
    .action-btn:hover {
      background-color: rgba(29, 161, 242, 0.1);
    }
    .action-btn i {
      font-size: 1.1rem;
    }
    .like-btn:hover {
      color: #e0245e;
      background-color: rgba(224, 36, 94, 0.1);
    }
    .like-btn.liked {
      color: #e0245e;
    }
    .reply-btn:hover {
      color: var(--twitter-blue);
      background-color: rgba(29, 161, 242, 0.1);
    }
    .retweet-btn:hover,
    .quote-btn:hover {
      color: #17bf63;
      background-color: rgba(23, 191, 99, 0.1);
    }
    
    /* Poll and quoted tweet */
    .poll-container {
      background-color: #f7f9fa;
      border: 1px solid var(--twitter-extra-light-gray);
      padding: 12px;
      margin: 10px 0;
      border-radius: 12px;
    }
    .poll-option {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      padding: 8px;
      background: white;
      border-radius: 5px;
      border: 1px solid var(--twitter-extra-light-gray);
    }
    .poll-vote-btn {
      background-color: var(--twitter-blue);
      color: #fff;
      border: none;
      padding: 4px 12px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .quoted-tweet {
      background-color: #f7f9fa;
      border: 1px solid var(--twitter-extra-light-gray);
      border-radius: 12px;
      padding: 12px;
      margin: 10px 0;
      font-size: 0.95rem;
    }
    
    /* Replies */
    .tweet-replies {
      margin-left: 25px;
      border-left: 2px solid var(--twitter-extra-light-gray);
      padding-left: 15px;
      margin-top: 10px;
    }
    .reply {
      padding: 10px 0;
      border-bottom: 1px solid var(--twitter-extra-light-gray);
    }
    .reply:last-child {
      border-bottom: none;
    }
    .reply-form, 
    .quote-form {
      margin: 10px 0;
      padding: 10px;
      border-radius: 12px;
      background: #f7f9fa;
      display: none;
    }
    .reply-form textarea, 
    .quote-form textarea {
      width: 100%;
      border: 1px solid var(--twitter-extra-light-gray);
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 10px;
    }
    
    /* Theme toggle */
    #themeToggle {
      cursor: pointer;
      background: none;
      border: none;
      padding: 8px 15px;
      color: var(--twitter-dark-gray);
      font-size: 1rem;
      border-radius: 20px;
      display: flex;
      align-items: center;
    }
    #themeToggle:hover {
      background-color: rgba(29, 161, 242, 0.1);
      color: var(--twitter-blue);
    }
    #themeToggle i {
      margin-right: 8px;
    }
    
    /* Search form */
    #searchForm {
      margin-bottom: 15px;
    }
    #searchInput {
      border-radius: 20px;
      border: 1px solid var(--twitter-extra-light-gray);
      padding-left: 40px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23657786' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'%3E%3C/circle%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'%3E%3C/line%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: 15px center;
    }
    
    /* Dark mode styles */
    body.dark-mode {
      background-color: #15202b;
      color: #fff;
    }
    body.dark-mode nav.navbar {
      background-color: #15202b;
      border-bottom: 1px solid #38444d;
    }
    body.dark-mode .sidebar .nav-link {
      color: #fff;
    }
    body.dark-mode .auth-form,
    body.dark-mode .tweet-form,
    body.dark-mode .tweet-feed,
    body.dark-mode #profileSection,
    body.dark-mode #premiumSection,
    body.dark-mode #userProfileSection,
    body.dark-mode #adminSection {
      background: #192734;
      border: none;
    }
    body.dark-mode .poll-container,
    body.dark-mode .quoted-tweet,
    body.dark-mode .reply-form,
    body.dark-mode .quote-form {
      background-color: #253341;
      border-color: #38444d;
    }
    body.dark-mode .poll-option {
      background-color: #192734;
      border-color: #38444d;
    }
    body.dark-mode input.form-control,
    body.dark-mode textarea.form-control {
      background: #253341;
      border: 1px solid #38444d;
      color: #fff;
    }
    body.dark-mode .tweet {
      border-bottom-color: #38444d;
    }
    body.dark-mode .tweet-username {
      color: #fff;
    }
    body.dark-mode .trending-section {
      background: #192734;
      border-color: #38444d;
    }
    body.dark-mode .trending-section h3 {
      color: #fff;
    }
    
    /* Trending Hashtags Section */
    .trending-section {
      margin-top: 20px;
      padding: 15px;
      background: #fff;
      border: 1px solid var(--twitter-extra-light-gray);
      border-radius: 15px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .trending-section h3 {
      font-size: 1.1rem;
      font-weight: bold;
      margin-bottom: 15px;
      color: var(--twitter-black);
    }
    .trending-list {
      list-style: none;
      padding: 0;
    }
    .trending-list li {
      margin-bottom: 12px;
    }
    .trending-list li a {
      color: var(--twitter-blue);
      text-decoration: none;
      font-weight: 500;
      display: block;
      padding: 5px 0;
    }
    .trending-list li a:hover {
      text-decoration: underline;
    }
    
    /* Space out buttons in refreshFeed */
    #refreshFeed .btn {
      margin-right: 10px;
    }
    
    /* Premium plans */
    .premium-plan {
      background-color: #f7f9fa;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 15px;
      border: 1px solid var(--twitter-extra-light-gray);
    }
    body.dark-mode .premium-plan {
      background-color: #253341;
      border-color: #38444d;
    }
    .premium-plan h3 {
      color: var(--twitter-blue);
      margin-bottom: 10px;
    }
    
    /* Admin section */
    .account-entry {
      padding: 10px;
      border-bottom: 1px solid var(--twitter-extra-light-gray);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    body.dark-mode .account-entry {
      border-bottom-color: #38444d;
    }
    .ban-btn {
      background-color: #e0245e;
      padding: 5px 10px;
      border-radius: 15px;
      border: none;
      color: white;
    }
    .ban-btn:disabled {
      background-color: #7d8e9b;
    }
    
    /* Views counter */
    .tweet-views {
      display: flex;
      align-items: center;
      color: var(--twitter-dark-gray);
      font-size: 0.85rem;
      margin-top: 5px;
      margin-bottom: 10px;
    }
    .tweet-views i {
      margin-right: 5px;
      font-size: 0.9rem;
    }
    
    /* Community Notes Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
    }
    
    .modal-content {
      background-color: white;
      margin: 10% auto;
      padding: 20px;
      border-radius: 15px;
      width: 50%;
      max-width: 500px;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .modal-title {
      font-weight: bold;
      font-size: 1.2rem;
    }
    
    .close-modal {
      cursor: pointer;
      font-size: 1.5rem;
    }
    
    .community-notes-container {
      max-height: 70vh;
      overflow-y: auto;
      padding: 10px 0;
    }
    
    .community-note-item {
      margin-bottom: 20px;
      border-bottom: 1px solid var(--twitter-extra-light-gray);
      padding-bottom: 20px;
    }
    
    .community-note-form {
      margin-top: 15px;
      display: flex;
      flex-direction: column;
    }
    
    .community-note-form textarea {
      width: 100%;
      border: 1px solid var(--twitter-light-gray);
      border-radius: 5px;
      resize: none;
      padding: 10px;
      margin-bottom: 10px;
      min-height: 80px;
    }
    
    .community-note-form button {
      background-color: var(--twitter-blue);
      color: white;
      border: none;
      border-radius: 30px;
      font-weight: bold;
      padding: 8px 16px;
      cursor: pointer;
      align-self: flex-end;
    }
    
    .community-note {
      background-color: rgba(29, 161, 242, 0.1);
      border: 1px solid rgba(29, 161, 242, 0.3);
      border-radius: 10px;
      padding: 12px;
      margin-top: 10px;
      font-size: 0.95rem;
    }
    
    .community-note-header {
      display: flex;
      align-items: center;
      color: var(--twitter-blue);
      margin-bottom: 5px;
      font-weight: 500;
    }
    
    .community-note-icon {
      margin-right: 8px;
      color: var(--twitter-blue);
    }
    
    .people-icon-group {
      position: relative;
      width: 24px;
      height: 24px;
      margin-right: 10px;
    }
    
    .people-icon {
      position: absolute;
      font-size: 0.8em;
    }
    
    .people-icon:nth-child(1) {
      top: 0;
      left: 0;
    }
    
    .people-icon:nth-child(2) {
      top: 0;
      right: 0;
    }
    
    .people-icon:nth-child(3) {
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
    }

    /* Ensure community notes look good in the tweet feed */
    .tweet-card .community-note {
      background-color: rgba(29, 161, 242, 0.1);
      border: 1px solid rgba(29, 161, 242, 0.3);
      border-radius: 10px;
      padding: 12px;
      margin: 10px 0;
      font-size: 0.95rem;
    }
    
    .tweet-card .community-note-header {
      display: flex;
      align-items: center;
      color: var(--twitter-blue);
      margin-bottom: 5px;
      font-weight: 500;
    }
    
    .tweet-card .community-note-text {
      color: var(--twitter-black);
    }
    
    body.dark-mode .tweet-card .community-note {
      background-color: rgba(29, 161, 242, 0.15);
      border-color: rgba(29, 161, 242, 0.4);
    }
    
    body.dark-mode .tweet-card .community-note-text {
      color: #fff;
    }
    
    /* Add CSS for quote modals and reply forms */
    .quote-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .quote-modal-content {
      background-color: white;
      padding: 20px;
      border-radius: 15px;
      width: 500px;
      max-width: 90%;
    }
    
    body.dark-mode .quote-modal-content {
      background-color: #15202b;
      color: white;
    }
    
    .quoted-tweet {
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 10px;
    }
    
    body.dark-mode .quoted-tweet {
      border-color: #38444d;
    }
    
    #quote-text {
      width: 100%;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
      margin: 10px 0;
      resize: none;
      min-height: 100px;
    }
    
    body.dark-mode #quote-text {
      background-color: #253341;
      color: white;
      border-color: #38444d;
    }
    
    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 10px;
    }
    
    .modal-buttons button {
      padding: 8px 15px;
      border-radius: 50px;
      border: none;
      cursor: pointer;
    }
    
    #cancel-quote {
      background-color: #e0e0e0;
      color: black;
    }
    
    #submit-quote {
      background-color: #1da1f2;
      color: white;
    }
    
    body.dark-mode #cancel-quote {
      background-color: #38444d;
      color: white;
    }
    
    .reply-form {
      margin: 10px 0;
      padding: 10px;
      border-top: 1px solid #e6ecf0;
    }
    
    body.dark-mode .reply-form {
      border-color: #38444d;
    }
    
    .reply-text {
      width: 100%;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
      resize: none;
      min-height: 80px;
    }
    
    body.dark-mode .reply-text {
      background-color: #253341;
      color: white;
      border-color: #38444d;
    }
    
    .reply-form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 10px;
    }
    
    .cancel-reply-btn,
    .submit-reply-btn {
      padding: 5px 15px;
      border-radius: 50px;
      border: none;
      cursor: pointer;
    }
    
    .cancel-reply-btn {
      background-color: #e0e0e0;
      color: black;
    }
    
    .submit-reply-btn {
      background-color: #1da1f2;
      color: white;
    }
    
    body.dark-mode .cancel-reply-btn {
      background-color: #38444d;
      color: white;
    }
    
    .replies-section {
      margin-top: 10px;
      border-top: 1px solid #e6ecf0;
      padding-top: 10px;
    }
    
    body.dark-mode .replies-section {
      border-color: #38444d;
    }
    
    .reply {
      padding: 10px;
      border-bottom: 1px solid #e6ecf0;
    }
    
    body.dark-mode .reply {
      border-color: #38444d;
    }
    
    .reply-header {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }
    
    .profile-pic-small {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      margin-right: 10px;
    }
    
    .reply-actions {
      margin-top: 5px;
      color: #657786;
      font-size: 0.9em;
    }
    
    .reply-like {
      cursor: pointer;
    }
    
    body.dark-mode .reply-like {
      color: #8899a6;
    }
    
    /* Add styles for reply button and modal */
    .tweet-actions {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
      padding-top: 5px;
      border-top: 1px solid rgba(0, 0, 0, 0.1);
    }
    
    body.dark-mode .tweet-actions {
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .tweet-action-button {
      background: none;
      border: none;
      color: #536471;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      padding: 5px;
      border-radius: 50%;
      transition: background-color 0.2s;
    }
    
    .tweet-action-button:hover {
      background-color: rgba(29, 161, 242, 0.1);
      color: #1d9bf0;
    }
    
    body.dark-mode .tweet-action-button {
      color: #8899a6;
    }
    
    body.dark-mode .tweet-action-button:hover {
      background-color: rgba(29, 161, 242, 0.1);
      color: #1d9bf0;
    }
    
    .reply-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .reply-modal-content {
      background-color: white;
      padding: 20px;
      border-radius: 15px;
      width: 500px;
      max-width: 90%;
    }
    
    body.dark-mode .reply-modal-content {
      background-color: #15202b;
      color: white;
    }
    
    .replying-to {
      font-size: 14px;
      color: #536471;
      margin-bottom: 10px;
    }
    
    body.dark-mode .replying-to {
      color: #8899a6;
    }
    
    .original-tweet {
      border-left: 2px solid #ccc;
      padding-left: 10px;
      margin-bottom: 15px;
      font-size: 14px;
    }
    
    body.dark-mode .original-tweet {
      border-left: 2px solid #38444d;
    }
    
    .reply-form {
      display: flex;
      flex-direction: column;
    }
    
    .reply-input {
      border: none;
      border-bottom: 1px solid #ccc;
      padding: 10px 0;
      margin-bottom: 15px;
      font-size: 16px;
      resize: none;
      background: transparent;
      color: inherit;
    }
    
    body.dark-mode .reply-input {
      border-bottom: 1px solid #38444d;
    }
    
    .reply-input:focus {
      outline: none;
      border-bottom: 2px solid #1d9bf0;
    }
    
    .reply-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    .reply-cancel {
      background: none;
      border: none;
      color: #536471;
      cursor: pointer;
      font-weight: bold;
      padding: 8px 16px;
      border-radius: 20px;
    }
    
    .reply-cancel:hover {
      background-color: rgba(0, 0, 0, 0.1);
    }
    
    body.dark-mode .reply-cancel {
      color: #8899a6;
    }
    
    body.dark-mode .reply-cancel:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }
    
    .reply-submit {
      background-color: #1d9bf0;
      border: none;
      color: white;
      cursor: pointer;
      font-weight: bold;
      padding: 8px 16px;
      border-radius: 20px;
    }
    
    .reply-submit:hover {
      background-color: #1a8cd8;
    }
    
    .reply-submit:disabled {
      background-color: #8ecdf8;
      cursor: default;
    }
    
    body.dark-mode .reply-submit:disabled {
      background-color: rgba(29, 155, 240, 0.5);
    }
    
    .tweet-card {
      background-color: white;
      border-radius: 15px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      transition: background-color 0.3s;
      cursor: pointer;
    }
    
    body.dark-mode .tweet-card {
      background-color: #192734;
      color: white;
    }

    /* Add tweet detail modal styles */
    .tweet-detail-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1001;
    }
    
    .tweet-detail-content {
      background-color: white;
      padding: 20px;
      border-radius: 15px;
      width: 600px;
      max-width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    body.dark-mode .tweet-detail-content {
      background-color: #15202b;
      color: white;
    }
    
    .tweet-detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 10px;
      border-bottom: 1px solid #e6ecf0;
      margin-bottom: 15px;
    }
    
    body.dark-mode .tweet-detail-header {
      border-color: #38444d;
    }
    
    .tweet-detail-close {
      background: none;
      border: none;
      color: #657786;
      font-size: 20px;
      cursor: pointer;
    }
    
    body.dark-mode .tweet-detail-close {
      color: #8899a6;
    }
    
    .tweet-detail-title {
      font-size: 19px;
      font-weight: bold;
      margin: 0;
    }
    
    .tweet-detail-main {
      margin-bottom: 15px;
    }
    
    .tweet-detail-replies {
      border-top: 1px solid #e6ecf0;
      padding-top: 15px;
    }
    
    body.dark-mode .tweet-detail-replies {
      border-color: #38444d;
    }
    
    .tweet-detail-reply-count {
      font-size: 15px;
      font-weight: bold;
      margin-bottom: 10px;
      color: #536471;
    }
    
    body.dark-mode .tweet-detail-reply-count {
      color: #8899a6;
    }

    /* Add styling to always show replies under tweets */
    .replies-section {
      margin-top: 10px;
      border-top: 1px solid #e6ecf0;
      padding-top: 10px;
    }
    
    body.dark-mode .replies-section {
      border-color: #38444d;
    }

    .replies-list {
      margin-left: 20px; /* Indent replies for better readability */
    }
    
    .reply {
      padding: 10px;
      border-bottom: 1px solid #e6ecf0;
    }
    
    body.dark-mode .reply {
      border-color: #38444d;
    }

    /* Improve the visibility of replies section */
    .replies-section {
      margin-top: 10px;
      border-top: 1px solid #e6ecf0;
      padding-top: 10px;
      margin-left: 15px; /* Add left margin to indent replies */
      border-left: 2px solid #1da1f2; /* Add a colored border to highlight replies */
      padding-left: 10px;
      display: block !important; /* Force display */
    }
    
    body.dark-mode .replies-section {
      border-color: #38444d;
      border-left-color: #1da1f2;
    }

    /* Make reply count header more visible */
    .reply-count-header {
      font-weight: bold;
      color: #536471;
      font-size: 14px;
      margin-bottom: 8px;
      padding-left: 5px;
      display: block !important; /* Force display */
    }
    
    body.dark-mode .reply-count-header {
      color: #8899a6;
    }

    .replies-list {
      margin-left: 5px; /* Reduce indentation for better alignment */
      display: block !important; /* Force display */
    }
    
    .reply {
      padding: 10px;
      border-bottom: 1px solid #e6ecf0;
      background-color: rgba(0, 0, 0, 0.02); /* Slight background to distinguish replies */
      border-radius: 8px;
      margin-bottom: 8px;
      display: block !important; /* Force display */
    }
    
    body.dark-mode .reply {
      border-color: #38444d;
      background-color: rgba(255, 255, 255, 0.02);
    }

    /* Remove cursor pointer from tweet cards to avoid confusion */
    .tweet-card {
      cursor: default;
    }

    /* Super obvious styling for replies to ensure they're visible */
    .replies-section {
      border: 2px solid #1da1f2;
      background-color: #f8f9fa;
      padding: 10px;
      margin-top: 15px;
      border-radius: 10px;
    }
    
    body.dark-mode .replies-section {
      background-color: #192734;
      border-color: #1da1f2;
    }
    
    .reply-count-header {
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 10px;
      color: #1da1f2;
    }
    
    .reply {
      border: 1px solid #e1e8ed;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 10px;
      background-color: white;
    }
    
    body.dark-mode .reply {
      background-color: #22303c;
      border-color: #38444d;
    }
    
    .reply-text-content {
      margin: 8px 0;
    }
  </style>
</head>
<body class="light-mode">
  <nav class="navbar navbar-expand-lg">
    <div class="container">
      <a class="navbar-brand" href="#"><i class="fab fa-twitter"></i> Twitter</a>
      <button id="themeToggle">
        <i class="fas fa-moon"></i>
        <span>Dark Mode</span>
      </button>
    </div>
  </nav>
  <div class="container main-container">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-md-3">
        <div class="sidebar">
          <a href="#" class="nav-link" onclick="fetchAndRenderTweets()">
            <i class="fas fa-home"></i>Home
          </a>
          <a href="#" class="nav-link" onclick="showEditableProfile()">
            <i class="fas fa-user"></i>Profile
          </a>
          <a href="#" class="nav-link" onclick="showPremiumSection()">
            <i class="fas fa-star"></i>Premium
          </a>
          <a href="#" class="nav-link" onclick="showAdminSection()">
            <i class="fas fa-shield-alt"></i>Admin
          </a>
          <a href="#" class="nav-link" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i>Logout
          </a>
          <a href="twitter.html" class="nav-link">
            <i class="fas fa-arrow-left"></i>Back to Klanite
          </a>
          <div id="trendingHashtags" class="trending-section">
            <h3><i class="fas fa-chart-line"></i> Trending</h3>
            <ul id="trendingList" class="trending-list"></ul>
          </div>
        </div>
      </div>
      <!-- Main Content -->
      <div class="col-md-9">
        <!-- Authentication -->
        <div id="authSection" class="auth-form">
          <h2>Log In / Sign Up</h2>
          <div class="form-group">
            <input type="text" id="authHandle" class="form-control" placeholder="Handle" />
          </div>
          <div class="form-group">
            <input type="password" id="authPassword" class="form-control" placeholder="Password" />
          </div>
          <button id="authButton" class="btn">Submit</button>
          <p id="authError" class="text-danger"></p>
        </div>
        <!-- Tweet Section -->
        <div id="tweetSection" style="display:none;">
          <div class="container mt-3">
            <form id="searchForm" class="form-inline">
              <input type="text" id="searchInput" class="form-control mr-2 w-100" placeholder="Search tweets" />
              <button type="submit" class="btn d-none">Search</button>
            </form>
          </div>
          <div class="tweet-form">
            <div class="form-group">
              <textarea id="tweetText" class="form-control" rows="3" placeholder="What's happening?"></textarea>
              <small id="charCount" style="float: right;">280</small>
            </div>
            <div class="form-group">
              <div class="d-flex align-items-center">
                <label for="tweetImage" class="mr-3 mb-0" style="cursor: pointer; color: var(--twitter-blue);">
                  <i class="far fa-image"></i>
                </label>
                <input type="file" id="tweetImage" class="form-control-file d-none" accept="image/*" />
                <button id="addPoll" class="btn-sm btn-light mr-3" style="background: none; border: none;">
                  <i class="fas fa-poll" style="color: var(--twitter-blue);"></i>
                </button>
              </div>
              <div id="pollFields" style="display: none; margin-top: 15px;">
                <input type="text" id="pollQuestion" class="form-control mb-2" placeholder="Poll question" />
                <input type="text" id="pollOption1" class="form-control mb-1" placeholder="Option 1" />
                <input type="text" id="pollOption2" class="form-control mb-1" placeholder="Option 2" />
                <button id="submitPollTweet" class="btn mt-2">Tweet with Poll</button>
              </div>
            </div>
            <button id="tweetButton" class="btn">Tweet</button>
          </div>
          <div id="refreshFeed" class="mt-3 mb-3">
            <button class="btn" onclick="fetchAndRenderTweets()">
              <i class="fas fa-sync-alt"></i> Refresh
            </button>
            <button id="toggleOrder" class="btn" onclick="toggleTweetOrder()">
              <i class="fas fa-random"></i> Random Order
            </button>
          </div>
          <div id="tweetFeed" class="tweet-feed"></div>
        </div>
        <!-- Premium Section -->
        <div id="premiumSection" style="display:none;">
          <h2><i class="fas fa-star"></i> Premium Subscription</h2>
          <div class="row">
            <div class="col-md-6">
              <div class="premium-plan">
                <h3><i class="fas fa-check-circle" style="color: #1DA1F2;"></i> Premium</h3>
                <p>Subscribe for blue checkmark verification.</p>
                <button onclick="subscribePlan('blue')" class="btn">Subscribe</button>
              </div>
            </div>
            <div class="col-md-6">
              <div class="premium-plan">
                <h3><i class="fas fa-check-circle" style="color: gold;"></i> Premium+</h3>
                <p>Subscribe for gold checkmark verification.</p>
                <button onclick="subscribePlan('gold')" class="btn">Subscribe</button>
              </div>
            </div>
          </div>
          <p id="premiumMessage" class="text-success mt-3"></p>
        </div>
        <!-- Profile Editing -->
        <div id="profileSection" style="display:none;">
          <h2><i class="fas fa-user-edit"></i> My Profile</h2>
          <div class="text-center mb-4">
            <img id="profilePicPreview" src="" alt="Profile Picture" style="width:120px; height:120px; border-radius:50%; margin-bottom:15px; object-fit: cover;" />
            <div class="form-group">
              <label for="profilePicUpload" class="btn">
                <i class="fas fa-camera"></i> Change Photo
              </label>
              <input type="file" id="profilePicUpload" class="form-control-file d-none" accept="image/*" />
            </div>
          </div>
          <div class="form-group">
            <label for="profileBio"><i class="fas fa-info-circle"></i> Bio:</label>
            <textarea id="profileBio" class="form-control" rows="4" placeholder="Write your bio here..."></textarea>
          </div>
          <div class="d-flex justify-content-between">
            <button id="saveBio" class="btn">Save Bio</button>
            <p id="profileMessage" class="text-success align-self-center mb-0"></p>
          </div>
        </div>
        <!-- User Profile View -->
        <div id="userProfileSection" style="display:none;">
          <button class="btn mb-3" onclick="backToMainFeed()">
            <i class="fas fa-arrow-left"></i> Back to Feed
          </button>
          <div class="d-flex align-items-center mb-3">
            <img id="userProfilePic" src="" alt="User Profile Picture" style="width:100px; height:100px; border-radius:50%; margin-right:20px; object-fit: cover;" />
            <div>
              <h2 id="userProfileName" class="mb-1"></h2>
              <p id="userProfileBio" class="text-muted mb-0"></p>
            </div>
          </div>
          <div id="userTweets" class="tweet-feed mt-4"></div>
        </div>
        <!-- Admin Panel -->
        <div id="adminSection" style="display:none;">
          <h2>Admin Panel</h2>
          <div class="d-flex justify-content-between mb-4">
            <button class="btn btn-light" onclick="fetchAndRenderTweets()">
              <i class="fas fa-arrow-left"></i> Back to Home
            </button>
          </div>
          <ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
            <li class="nav-item">
              <a class="nav-link active" id="accounts-tab" data-toggle="tab" href="#accounts" role="tab">Accounts</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="communitynotes-tab" data-toggle="tab" href="#communitynotes" role="tab">Community Notes</a>
            </li>
          </ul>
          <div class="tab-content" id="adminTabContent">
            <!-- Accounts tab -->
            <div class="tab-pane fade show active" id="accounts" role="tabpanel">
              <h3>Manage User Accounts</h3>
              <div id="accountList"></div>
            </div>
            <!-- Community Notes tab -->
            <div class="tab-pane fade" id="communitynotes" role="tabpanel">
              <h3>Manage Community Notes</h3>
              <p>Add context to tweets that will be visible to all users.</p>
              <p class="text-muted mb-4">Community notes appear under tweets to provide additional context or fact-checking information.</p>
              <div id="communityNotesAdminContainer"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    document.body.classList.add("light-mode");
    document.getElementById("themeToggle").addEventListener("click", () => {
      if (document.body.classList.contains("light-mode")) {
        document.body.classList.remove("light-mode");
        document.body.classList.add("dark-mode");
        document.getElementById("themeToggle").textContent = "Toggle Light Mode";
      } else {
        document.body.classList.remove("dark-mode");
        document.body.classList.add("light-mode");
        document.getElementById("themeToggle").textContent = "Toggle Dark Mode";
      }
    });

    let currentUser = null;
    let isRandomOrder = false; // Track if we're in random mode (false = newest to oldest)

    function toggleTweetOrder() {
      isRandomOrder = !isRandomOrder; // Flip the mode
      const toggleButton = document.getElementById("toggleOrder");
      toggleButton.textContent = isRandomOrder ? "Newest First" : "Random Order"; // Update button text
      fetchAndRenderTweets(); // Refresh the feed with the new order
    }

    function showAuthError(msg) {
      document.getElementById("authError").textContent = msg;
    }

    function handleSuccessfulAuth(handle) {
      currentUser = handle.toLowerCase();
      document.getElementById("authSection").style.display = "none";
      document.getElementById("tweetSection").style.display = "block";
      document.getElementById("profileSection").style.display = "none";
      document.getElementById("premiumSection").style.display = "none";
      document.getElementById("userProfileSection").style.display = "none";
      document.getElementById("adminSection").style.display = "none";
      fetchAndRenderTweets();
    }

    document.getElementById("authButton").addEventListener("click", async () => {
      const handle = document.getElementById("authHandle").value.trim();
      const password = document.getElementById("authPassword").value.trim();
      if (!handle || !password) {
        showAuthError("Please enter both handle and password.");
        return;
      }
      try {
        const loginResponse = await fetch("/api/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ handle, password })
        });
        const loginData = await loginResponse.json();
        if (loginData.success) {
          handleSuccessfulAuth(handle);
        } else if (loginData.error === "User not found") {
          const signupResponse = await fetch("/api/signup", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ handle, password })
          });
          const signupData = await signupResponse.json();
          if (signupData.success) {
            handleSuccessfulAuth(handle);
          } else {
            showAuthError(signupData.error || "Sign up failed.");
          }
        } else {
          showAuthError(loginData.error || "Authentication failed.");
        }
      } catch (err) {
        console.error(err);
        showAuthError("An error occurred. Please try again.");
      }
    });

    function logout() {
      currentUser = null;
      document.getElementById("tweetSection").style.display = "none";
      document.getElementById("profileSection").style.display = "none";
      document.getElementById("premiumSection").style.display = "none";
      document.getElementById("userProfileSection").style.display = "none";
      document.getElementById("adminSection").style.display = "none";
      document.getElementById("authSection").style.display = "block";
    }

    async function postTweet(text, imageData = null, retweetOf = null, quotedTweet = null, pollData = null) {
      // Generate random view count based on three tiers
      let viewCount;
      const tier = Math.floor(Math.random() * 3); // 0, 1, or 2
      
      if (tier === 0) {
        // Small post: 1-999 views
        viewCount = Math.floor(Math.random() * 999) + 1;
      } else if (tier === 1) {
        // Medium post: 1k-999k views
        viewCount = Math.floor(Math.random() * 999000) + 1000;
      } else {
        // Big post: 1m-999m views
        viewCount = Math.floor(Math.random() * 999000000) + 1000000;
      }
      
      const newTweet = { 
        handle: currentUser, 
        text, 
        imageData, 
        timestamp: Date.now(), 
        poll: pollData,
        views: viewCount
      };
      
      if (retweetOf) newTweet.retweetOf = retweetOf;
      if (quotedTweet) newTweet.quotedTweet = quotedTweet;
      
      return fetch("/api/tweet", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(newTweet)
      }).then(response => response.json());
    }

    document.getElementById("tweetButton").addEventListener("click", async () => {
      const text = document.getElementById("tweetText").value.trim();
      const imageInput = document.getElementById("tweetImage");
      if ((!text && imageInput.files.length === 0) || text.length > 280) return;
      let imageData = null;
      if (imageInput.files.length > 0) {
        imageData = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = () => reject("Error reading file");
          reader.readAsDataURL(imageInput.files[0]);
        });
      }
      const result = await postTweet(text, imageData);
      if (result.success) fetchAndRenderTweets();
      document.getElementById("tweetText").value = "";
      document.getElementById("tweetImage").value = "";
    });

    document.getElementById("tweetText").addEventListener("input", function () {
      const maxLength = 280;
      const currentLength = this.value.length;
      const remaining = maxLength - currentLength;
      const charCount = document.getElementById("charCount");
      charCount.textContent = remaining;
      charCount.style.color = remaining <= 10 ? "#e0245e" : "#555";
      document.getElementById("tweetButton").disabled = currentLength > maxLength;
    });

    document.getElementById("addPoll").addEventListener("click", () => {
      const pollFields = document.getElementById("pollFields");
      pollFields.style.display = pollFields.style.display === "none" ? "block" : "none";
    });

    document.getElementById("searchForm").addEventListener("submit", function(event) {
      event.preventDefault();
      const query = document.getElementById("searchInput").value.trim();
      fetchAndRenderTweets(query);
    });

    async function fetchAndRenderTweets(query = "") {
      const response = await fetch("/api/tweets");
      const data = await response.json();
      let tweets = data.tweets;
      if (query) {
        tweets = filterTweets(tweets, query);
      }
      if (isRandomOrder) {
        // Shuffle tweets randomly (Fisher-Yates shuffle)
        for (let i = tweets.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [tweets[i], tweets[j]] = [tweets[j], tweets[i]];
        }
      } else {
        tweets.sort((a, b) => b.timestamp - a.timestamp); // Newest to oldest
      }
      renderTweets(tweets);
      renderTrendingHashtags(data.tweets);
    }

    function filterTweets(tweets, query) {
      const lowerQuery = query.toLowerCase();
      if (query.startsWith("@")) {
        const handle = query.slice(1).toLowerCase();
        return tweets.filter(tweet => tweet.text.toLowerCase().includes("@" + handle));
      } else if (query.startsWith("#")) {
        const hashtag = query.slice(1).toLowerCase();
        return tweets.filter(tweet => tweet.text.toLowerCase().includes("#" + hashtag));
      } else {
        return tweets.filter(tweet => tweet.text.toLowerCase().includes(lowerQuery));
      }
    }

    document.getElementById("submitPollTweet").addEventListener("click", async () => {
      const text = document.getElementById("tweetText").value.trim();
      const question = document.getElementById("pollQuestion").value.trim();
      const option1 = document.getElementById("pollOption1").value.trim();
      const option2 = document.getElementById("pollOption2").value.trim();
      const imageInput = document.getElementById("tweetImage");
      if ((!text && imageInput.files.length === 0 && !question) || text.length > 280) return;
      if (question && (!option1 || !option2)) return;
      let imageData = null;
      if (imageInput.files.length > 0) {
        imageData = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = () => reject("Error reading file");
          reader.readAsDataURL(imageInput.files[0]);
        });
      }
      const pollData = question ? { question, options: [{ text: option1, votes: 0 }, { text: option2, votes: 0 }] } : null;
      try {
        const result = await postTweet(text, imageData, null, null, pollData);
        if (result.success) {
          fetchAndRenderTweets();
        }
      } catch (error) {
        console.error("Error during postTweet:", error);
      }
      document.getElementById("tweetText").value = "";
      document.getElementById("tweetImage").value = "";
      document.getElementById("pollQuestion").value = "";
      document.getElementById("pollOption1").value = "";
      document.getElementById("pollOption2").value = "";
      document.getElementById("pollFields").style.display = "none";
    });

    function formatTweet(tweet, showQuote = false) {
      const formattedDate = new Date(tweet.timestamp).toLocaleString();
      
      // Check if user has liked this tweet
      const isLiked = currentUser && tweet.likedBy && tweet.likedBy.includes(currentUser);
      
      // Get profile picture or default
      const profilePicHtml = tweet.profilePicture 
        ? `<img src="${tweet.profilePicture}" alt="Profile" class="tweet-profile-pic">` 
        : `<div class="default-profile-pic"><i class="fas fa-user"></i></div>`;
        
      // Format the tweet text (process @mentions and #hashtags)
      const formattedText = tweet.text.replace(/@(\w+)/g, '<a href="#" class="mention">@$1</a>')
                                     .replace(/#(\w+)/g, '<a href="#" class="hashtag">#$1</a>');
      
      // Format image if present
      const imageHtml = tweet.imageData
        ? `<div class="tweet-image"><img src="${tweet.imageData}" alt="Tweet image" style="max-width: 100%; border-radius: 15px;"></div>`
        : '';
      
      // Format verification badge if user is verified
      const verifiedBadge = tweet.verified 
        ? `<i class="fas fa-check-circle verification-badge" style="color: ${tweet.verified === 'gold' ? 'gold' : 'var(--twitter-blue)'}" title="${tweet.verified}"></i>` 
        : '';
      
      // Format poll if present
      let pollHtml = '';
      if (tweet.poll && tweet.poll.options && tweet.poll.options.length > 0) {
        const totalVotes = tweet.poll.options.reduce((sum, option) => sum + option.votes, 0);
        pollHtml = `
          <div class="poll-container">
            <div class="poll-question">${tweet.poll.question || 'Poll'}</div>
            ${tweet.poll.options.map(option => {
              const percentage = totalVotes > 0 ? Math.round((option.votes / totalVotes) * 100) : 0;
              return `
                <div class="poll-option" data-option="${option.text}" data-tweet-id="${tweet.id}">
                  <div class="poll-bar" style="width: ${percentage}%;"></div>
                  <div class="poll-content">
                    <span class="poll-text">${option.text}</span>
                    <span class="poll-percentage">${percentage}%</span>
                  </div>
                </div>
              `;
            }).join('')}
            <div class="poll-votes">${totalVotes} votes</div>
          </div>
        `;
      }
      
      // Format quoted tweet if present
      let quotedTweetHtml = '';
      if (tweet.quotedTweet && !showQuote) { // Prevent infinite nesting of quotes
        quotedTweetHtml = `
          <div class="quoted-tweet">
            ${formatTweet(tweet.quotedTweet, true)}
          </div>
        `;
      }
      
      // Format retweet info if present
      const retweetInfo = tweet.last_retweeted_by 
        ? `<div class="retweet-info"><i class="fas fa-retweet"></i> ${tweet.last_retweeted_by} Retweeted</div>` 
        : '';
      
      // Format community notes if present
      const communityNoteHtml = tweet.communityNotes && tweet.communityNotes.length > 0 
        ? `
          <div class="community-note">
            <div class="community-note-header">
              <div class="people-icon-group">
                <i class="fas fa-user people-icon"></i>
                <i class="fas fa-user people-icon"></i>
                <i class="fas fa-user people-icon"></i>
              </div>
              Readers added context
            </div>
            <div class="community-note-text">
              ${tweet.communityNotes[0].text}
            </div>
          </div>
        ` 
        : '';
      
      // Combine all the elements
      return `
        ${retweetInfo}
        <div class="tweet-card ${showQuote ? 'quoted' : ''}" data-tweet-id="${tweet.id}">
          <div class="tweet-header">
            ${profilePicHtml}
            <div class="tweet-header-info">
              <span class="tweet-name">${tweet.handle} ${verifiedBadge}</span>
              <span class="tweet-handle">@${tweet.handle}</span>
              <span class="tweet-dot">·</span>
              <span class="tweet-time">${formattedDate}</span>
            </div>
          </div>
          <div class="tweet-body">
            <div class="tweet-text">${formattedText}</div>
            ${imageHtml}
            ${pollHtml}
            ${quotedTweetHtml}
          </div>
          <div class="tweet-views">
            <i class="fas fa-chart-bar"></i> ${formatViews(tweet.views || 0)} views
          </div>
          ${communityNoteHtml}
          <div class="tweet-actions">
            <button class="action-btn reply-btn" onclick="showReplyModal('${tweet.id}')">
              <i class="far fa-comment"></i>
              <span>${tweet.replies ? tweet.replies.length : 0}</span>
            </button>
            <button class="action-btn retweet-btn" onclick="retweetTweet('${tweet.id}')">
              <i class="fas fa-retweet"></i>
              <span>${tweet.retweets || 0}</span>
            </button>
            <button class="action-btn like-btn ${isLiked ? 'liked' : ''}" onclick="likeTweet('${tweet.id}')">
              <i class="${isLiked ? 'fas' : 'far'} fa-heart"></i>
              <span>${tweet.likes || 0}</span>
            </button>
            <button class="action-btn share-btn" onclick="showShareTweet('${tweet.id}')">
              <i class="far fa-share-square"></i>
            </button>
          </div>
        </div>
      `;
    }

    function renderTweets(tweets) {
      const feed = document.getElementById("tweetFeed");
      feed.innerHTML = "";
      tweets.forEach(tweet => {
        const tweetDiv = document.createElement("div");
        tweetDiv.className = "tweet";
        tweetDiv.innerHTML = formatTweet(tweet);
        feed.appendChild(tweetDiv);
      });
      
      // Add event listeners to tweet buttons after rendering
      document.querySelectorAll('.tweet-card').forEach(tweet => {
        const tweetId = tweet.getAttribute('data-tweet-id');
        
        // Share/Quote button
        const shareBtn = tweet.querySelector('.share-btn');
        if (shareBtn) {
          shareBtn.onclick = function(e) {
            e.preventDefault();
            e.stopPropagation();
            showShareTweet(tweetId);
          };
        }
      });
    }

    function renderTrendingHashtags(tweets) {
      const hashtagCount = {}; // This is like a notebook to count hashtags
      
      // Look through every tweet and count its hashtags
      tweets.forEach(tweet => {
        const hashtags = tweet.text.match(/#([a-zA-Z0-9]+)/g) || []; // Find all #hashtags
        hashtags.forEach(tag => {
          const cleanTag = tag.toLowerCase(); // Make #Cool and #cool the same
          hashtagCount[cleanTag] = (hashtagCount[cleanTag] || 0) + 1; // Add 1 to the count
        });
      });

      // Pick only hashtags used 2 or more times, sort them, and take the top 5
      const trending = Object.entries(hashtagCount)
        .filter(([tag, count]) => count >= 2) // Keep only 2+ uses
        .sort((a, b) => b[1] - a[1]) // Sort by count (highest first)
        .slice(0, 5); // Take top 5

      // Show them in the trending list
      const trendingList = document.getElementById("trendingList");
      trendingList.innerHTML = ""; // Clear the old list
      trending.forEach(([tag, count]) => {
        const li = document.createElement("li"); // Make a list item
        const a = document.createElement("a"); // Make a clickable link
        a.href = "#"; // Prevent page jump
        a.textContent = `${tag} (${count})`; // Show "#tag (count)"
        a.addEventListener("click", (e) => {
          e.preventDefault(); // Stop the link from jumping
          fetchAndRenderTweets(tag); // Show tweets with this hashtag
        });
        li.appendChild(a); // Put the link in the list item
        trendingList.appendChild(li); // Put the list item in the list
      });
    }

    async function fetchProfile(handle) {
      const response = await fetch(`/api/profile?handle=${handle}`);
      const data = await response.json();
      return data.success ? data.profile : null;
    }

    async function showEditableProfile() {
      if (!currentUser) return;
      const profile = await fetchProfile(currentUser);
      if (profile) {
        document.getElementById("profilePicPreview").src = profile.profilePicture || "images/default.png";
        document.getElementById("profileBio").value = profile.bio || "";
      }
      document.getElementById("tweetSection").style.display = "none";
      document.getElementById("userProfileSection").style.display = "none";
      document.getElementById("premiumSection").style.display = "none";
      document.getElementById("adminSection").style.display = "none";
      document.getElementById("profileSection").style.display = "block";
    }

    async function showUserProfile(username) {
      const profile = await fetchProfile(username);
      if (profile) {
        document.getElementById("userProfileName").textContent = username;
        document.getElementById("userProfilePic").src = profile.profilePicture || "images/default.png";
        document.getElementById("userProfileBio").textContent = profile.bio || "";
        const response = await fetch("/api/tweets");
        const data = await response.json();
        const filteredTweets = data.tweets.filter(t => t.handle.toLowerCase() === username.toLowerCase());
        const userTweetsDiv = document.getElementById("userTweets");
        userTweetsDiv.innerHTML = "";
        renderUserTweets(filteredTweets, userTweetsDiv);
      }
      document.getElementById("tweetSection").style.display = "none";
      document.getElementById("profileSection").style.display = "none";
      document.getElementById("premiumSection").style.display = "none";
      document.getElementById("adminSection").style.display = "none";
      document.getElementById("userProfileSection").style.display = "block";
    }

    function renderUserTweets(tweets, container) {
      tweets.forEach(tweet => {
        const tweetDiv = document.createElement("div");
        tweetDiv.className = "tweet";
        tweetDiv.innerHTML = formatTweet(tweet);
        container.appendChild(tweetDiv);
      });
    }

    function backToMainFeed() {
      document.getElementById("userProfileSection").style.display = "none";
      document.getElementById("adminSection").style.display = "none";
      document.getElementById("tweetSection").style.display = "block";
      fetchAndRenderTweets();
    }

    function showPremiumSection() {
      document.getElementById("tweetSection").style.display = "none";
      document.getElementById("profileSection").style.display = "none";
      document.getElementById("userProfileSection").style.display = "none";
      document.getElementById("adminSection").style.display = "none";
      document.getElementById("premiumSection").style.display = "block";
    }

    function subscribePlan(plan) {
      if (!currentUser) return;
      fetch("/api/profile", {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ handle: currentUser, verified: plan })
      }).then(response => response.json()).then(data => {
        if (data.success) {
          document.getElementById("premiumMessage").textContent = 
            plan === "blue" ? "You are now a Premium subscriber (blue check)!" : "You are now a Premium+ subscriber (gold check)!";
          fetchAndRenderTweets();
        }
      });
    }

    document.getElementById("saveBio").addEventListener("click", async () => {
      if (!currentUser) return;
      const bioText = document.getElementById("profileBio").value.trim();
      const response = await fetch("/api/profile", {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ handle: currentUser, bio: bioText })
      });
      const data = await response.json();
      if (data.success) {
        document.getElementById("profileMessage").textContent = "Bio saved successfully!";
        setTimeout(() => document.getElementById("profileMessage").textContent = "", 3000);
      }
    });

    document.getElementById("updateProfilePic").addEventListener("click", async () => {
      if (!currentUser) return;
      const fileInput = document.getElementById("profilePicUpload");
      if (fileInput.files.length === 0) return;
      const imageData = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => reject("Error reading file");
        reader.readAsDataURL(fileInput.files[0]);
      });
      const response = await fetch("/api/profile", {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ handle: currentUser, profilePicture: imageData })
      });
      const data = await response.json();
      if (data.success) {
        document.getElementById("profilePicPreview").src = imageData;
        document.getElementById("profileMessage").textContent = "Profile picture updated successfully.";
        fetchAndRenderTweets();
      }
    });

    async function showAdminSection() {
      const password = prompt("Enter admin password:");
      if (password !== "1612") {
        alert("Incorrect admin password.");
        return;
      }
      
      // Fetch and display user accounts
      const response = await fetch("/api/users");
      const data = await response.json();
      if (data.success) {
        const accountList = document.getElementById("accountList");
        accountList.innerHTML = "";
        data.users.forEach(user => {
          const entry = document.createElement("div");
          entry.className = "account-entry";
          const info = document.createElement("span");
          info.textContent = `${user.handle} - ${user.password}${user.banned ? " (Banned)" : ""}`;
          const banBtn = document.createElement("button");
          banBtn.className = "ban-btn";
          banBtn.textContent = user.banned ? "Banned" : "Ban";
          banBtn.disabled = user.banned;
          banBtn.addEventListener("click", async () => {
            const banResponse = await fetch("/api/ban", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ handle: user.handle })
            });
            const banData = await banResponse.json();
            if (banData.success) {
              banBtn.textContent = "Banned";
              banBtn.disabled = true;
              info.textContent = `${user.handle} - ${user.password} (Banned)`;
            }
          });
          entry.appendChild(info);
          entry.appendChild(banBtn);
          accountList.appendChild(entry);
        });
      }
      
      // Load community notes section
      loadCommunityNotesAdmin();
      
      // Hide other sections and show admin section
      document.getElementById("tweetSection").style.display = "none";
      document.getElementById("profileSection").style.display = "none";
      document.getElementById("premiumSection").style.display = "none";
      document.getElementById("userProfileSection").style.display = "none";
      document.getElementById("adminSection").style.display = "block";
    }

    // Community Notes
    let communityNotesEnabled = false;

    // New function to load community notes in admin panel
    async function loadCommunityNotesAdmin() {
      const container = document.getElementById('communityNotesAdminContainer');
      container.innerHTML = '<p>Loading tweets...</p>';
      
      try {
        const response = await fetch('/api/tweets');
        const data = await response.json();
        
        if (data.success) {
          container.innerHTML = '';
          
          data.tweets.forEach(tweet => {
            const tweetElement = document.createElement('div');
            tweetElement.className = 'community-note-item';
            
            const noteExists = tweet.communityNotes && tweet.communityNotes.length > 0;
            
            tweetElement.innerHTML = `
              <div class="tweet-header">
                <span class="tweet-name">${tweet.handle}</span>
                <span class="tweet-handle">@${tweet.handle}</span>
              </div>
              <div class="tweet-text">${tweet.text}</div>
              
              ${noteExists ? `
                <div class="community-note">
                  <div class="community-note-header">
                    <div class="people-icon-group">
                      <i class="fas fa-user people-icon"></i>
                      <i class="fas fa-user people-icon"></i>
                      <i class="fas fa-user people-icon"></i>
                    </div>
                    Readers added context
                  </div>
                  <div class="community-note-text">
                    ${tweet.communityNotes[0].text}
                  </div>
                </div>
              ` : ''}
              
              <div class="community-note-form">
                <textarea placeholder="Add a community note to provide context..." id="note-${tweet.id}"></textarea>
                <button onclick="addCommunityNote(${tweet.id})">Submit</button>
              </div>
            `;
            
            container.appendChild(tweetElement);
          });
        } else {
          container.innerHTML = '<p>Error loading tweets.</p>';
        }
      } catch (error) {
        console.error('Error fetching tweets for community notes:', error);
        container.innerHTML = '<p>Error loading tweets.</p>';
      }
    }

    async function addCommunityNote(tweetId) {
      const noteText = document.getElementById(`note-${tweetId}`).value.trim();
      
      if (!noteText) {
        alert('Please enter a note.');
        return;
      }
      
      try {
        const response = await fetch('/api/community-notes', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ tweetId, noteText })
        });
        
        const data = await response.json();
        
        if (data.success) {
          alert('Community note added successfully!');
          document.getElementById(`note-${tweetId}`).value = '';
          
          // Refresh the displays
          loadCommunityNotesAdmin(); // Refresh the admin panel
          fetchAndRenderTweets(); // Refresh the main feed to show the new note
        } else {
          alert(`Failed to add note: ${data.error}`);
        }
      } catch (error) {
        console.error('Error adding community note:', error);
        alert('Failed to add community note. Please try again.');
      }
    }

    // Initialize when the DOM is fully loaded
    document.addEventListener("DOMContentLoaded", function() {
      checkAuthentication();
      setupEventListeners();
      updateThemeDisplay();
      updateCharCount();
      fetchTrendingHashtags();
      
      // Community notes listeners removed since they're now in the admin panel
    });

    // Setup event listeners for the main UI

    // Function to format view counts in a more readable way (1K, 1M, etc.)
    function formatViews(views) {
      if (views >= 1000000) {
        return (views / 1000000).toFixed(1) + 'M';
      } else if (views >= 1000) {
        return (views / 1000).toFixed(1) + 'K';
      } else {
        return views.toString();
      }
    }

    // Update the likeTweet function to match the server endpoint
    async function likeTweet(tweetId) {
      if (!currentUser) return;
      
      try {
        // Get the current tweet element
        const tweetElement = document.querySelector(`.tweet-card[data-tweet-id="${tweetId}"]`);
        const likeBtn = tweetElement.querySelector(".like-btn");
        const likesCount = likeBtn.querySelector("span");
        const heartIcon = likeBtn.querySelector("i");
        
        // Determine current liked state and new like count
        const isCurrentlyLiked = likeBtn.classList.contains("liked");
        const currentLikes = parseInt(likesCount.textContent || 0);
        const newLikes = isCurrentlyLiked ? Math.max(currentLikes - 1, 0) : currentLikes + 1;
        
        // Make the API call to update likes on server
        const response = await fetch("/api/tweet/like", {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            id: tweetId, 
            likes: newLikes 
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Update the UI
          if (isCurrentlyLiked) {
            likeBtn.classList.remove("liked");
            heartIcon.classList.replace("fas", "far");
            likesCount.textContent = newLikes;
          } else {
            likeBtn.classList.add("liked");
            heartIcon.classList.replace("far", "fas");
            likesCount.textContent = newLikes;
            // Add like animation
            heartIcon.style.animation = 'none';
            setTimeout(() => {
              heartIcon.style.animation = 'likeAnimation 0.45s ease-in-out';
            }, 10);
          }
        }
      } catch (error) {
        console.error("Error liking tweet:", error);
      }
    }

    // Implement simplified reply functionality
    function showReplyModal(tweetId) {
      if (!currentUser) {
        alert("Please log in to reply");
        return;
      }
      
      // Get the tweet element
      const tweetElement = document.querySelector(`.tweet-card[data-tweet-id="${tweetId}"]`);
      
      // Check if reply form already exists
      if (tweetElement.querySelector('.reply-form')) {
        return; // Form already open
      }
      
      // Create inline reply form
      const replyForm = document.createElement('div');
      replyForm.className = 'reply-form';
      replyForm.innerHTML = `
        <div class="reply-input-container">
          <textarea class="reply-textarea" placeholder="Tweet your reply" maxlength="280"></textarea>
          <div class="reply-actions">
            <span class="reply-char-count">280</span>
            <button class="reply-submit-btn">Reply</button>
          </div>
        </div>
      `;
      
      // Add the form after the tweet actions
      const tweetActions = tweetElement.querySelector('.tweet-actions');
      tweetActions.parentNode.insertBefore(replyForm, tweetActions.nextSibling);
      
      // Add event listeners
      const textarea = replyForm.querySelector('.reply-textarea');
      const charCount = replyForm.querySelector('.reply-char-count');
      const submitBtn = replyForm.querySelector('.reply-submit-btn');
      
      // Focus the textarea
      textarea.focus();
      
      // Update character count
      textarea.addEventListener('input', function() {
        const remaining = 280 - this.value.length;
        charCount.textContent = remaining;
        charCount.style.color = remaining <= 20 ? '#e0245e' : '';
      });
      
      // Handle submit
      submitBtn.addEventListener('click', async function() {
        const replyText = textarea.value.trim();
        if (!replyText) return;
        
        try {
          const response = await fetch('/api/tweet/reply', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              tweetId: parseInt(tweetId),
              handle: currentUser,
              text: replyText
            })
          });
          
          const data = await response.json();
          
          if (data.success) {
            // Remove the reply form
            replyForm.remove();
            
            // Refresh the feed to show the new reply
            fetchAndRenderTweets();
          } else {
            alert('Error posting reply: ' + (data.error || 'Unknown error'));
          }
        } catch (error) {
          console.error('Error posting reply:', error);
          alert('Error posting reply. Please try again.');
        }
      });
      
      // Add cancel button
      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'reply-cancel-btn';
      cancelBtn.textContent = 'Cancel';
      cancelBtn.addEventListener('click', function() {
        replyForm.remove();
      });
      
      replyForm.querySelector('.reply-actions').appendChild(cancelBtn);
    }
    
    // Implement simplified quote tweet functionality
    function showShareTweet(tweetId) {
      if (!currentUser) {
        alert("Please log in to quote tweet");
        return;
      }
      
      // Get the tweet element
      const tweetElement = document.querySelector(`.tweet-card[data-tweet-id="${tweetId}"]`);
      
      // Check if quote form already exists
      let quoteForm = tweetElement.querySelector('.quote-form');
      if (quoteForm) {
        quoteForm.remove();
        return; // Toggle form visibility
      }
      
      // Get the original tweet text
      const tweetText = tweetElement.querySelector('.tweet-text').textContent;
      const tweetHandle = tweetElement.querySelector('.tweet-name').textContent.split(' ')[0];
      
      // Create inline quote form
      quoteForm = document.createElement('div');
      quoteForm.className = 'quote-form';
      quoteForm.innerHTML = `
        <div class="quote-input-container">
          <textarea class="quote-textarea" placeholder="Add a comment" maxlength="280"></textarea>
          <div class="quoted-preview">
            <strong>@${tweetHandle}:</strong> ${tweetText}
          </div>
          <div class="quote-actions">
            <span class="quote-char-count">280</span>
            <button class="quote-submit-btn">Quote Tweet</button>
            <button class="quote-cancel-btn">Cancel</button>
          </div>
        </div>
      `;
      
      // Add the form after the tweet actions
      const tweetActions = tweetElement.querySelector('.tweet-actions');
      tweetActions.parentNode.insertBefore(quoteForm, tweetActions.nextSibling);
      
      // Add event listeners
      const textarea = quoteForm.querySelector('.quote-textarea');
      const charCount = quoteForm.querySelector('.quote-char-count');
      const submitBtn = quoteForm.querySelector('.quote-submit-btn');
      const cancelBtn = quoteForm.querySelector('.quote-cancel-btn');
      
      // Focus the textarea
      textarea.focus();
      
      // Update character count
      textarea.addEventListener('input', function() {
        const remaining = 280 - this.value.length;
        charCount.textContent = remaining;
        charCount.style.color = remaining <= 20 ? '#e0245e' : '';
      });
      
      // Handle submit
      submitBtn.addEventListener('click', async function() {
        const quoteText = textarea.value.trim();
        
        try {
          // Get the tweet ID we're quoting
          const response = await fetch('/api/tweets');
          const data = await response.json();
          
          if (data.success) {
            const originalTweet = data.tweets.find(t => t.id == tweetId);
            
            if (!originalTweet) {
              alert('Error: Original tweet not found');
              return;
            }
            
            // Post the quote tweet
            const postResponse = await fetch('/api/tweet', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                handle: currentUser,
                text: quoteText,
                timestamp: Date.now(),
                quotedTweet: originalTweet
              })
            });
            
            const postData = await postResponse.json();
            
            if (postData.success) {
              // Remove the quote form
              quoteForm.remove();
              
              // Refresh the feed to show the new quote tweet
              fetchAndRenderTweets();
            } else {
              alert('Error posting quote tweet: ' + (postData.error || 'Unknown error'));
            }
          } else {
            alert('Error fetching original tweet: ' + (data.error || 'Unknown error'));
          }
        } catch (error) {
          console.error('Error posting quote tweet:', error);
          alert('Error posting quote tweet. Please try again.');
        }
      });
      
      // Cancel button
      cancelBtn.addEventListener('click', function() {
        quoteForm.remove();
      });
    }

    // Add CSS styles for inline reply and quote forms
    document.addEventListener("DOMContentLoaded", function() {
      // Add CSS for better interaction feedback
      const style = document.createElement('style');
      style.innerHTML = `
        .action-btn {
          display: flex;
          align-items: center;
          padding: 8px 12px;
          border-radius: 50px;
          margin-right: 8px;
          transition: all 0.2s ease;
          color: var(--twitter-dark-gray);
        }
        
        .action-btn i {
          margin-right: 5px;
        }
        
        .reply-btn:hover {
          color: var(--twitter-blue);
          background-color: rgba(29, 161, 242, 0.1);
        }
        
        .retweet-btn:hover {
          color: #17bf63;
          background-color: rgba(23, 191, 99, 0.1);
        }
        
        .retweet-btn.retweeted,
        .retweet-btn.retweeted:hover {
          color: #17bf63;
        }
        
        .like-btn:hover {
          color: #e0245e;
          background-color: rgba(224, 36, 94, 0.1);
        }
        
        .like-btn.liked {
          color: #e0245e;
        }
        
        .like-btn.liked i {
          animation: likeAnimation 0.45s ease-in-out;
        }
        
        .share-btn:hover {
          color: var(--twitter-blue);
          background-color: rgba(29, 161, 242, 0.1);
        }
        
        @keyframes likeAnimation {
          0% { transform: scale(1); }
          25% { transform: scale(1.2); }
          50% { transform: scale(0.95); }
          100% { transform: scale(1); }
        }
        
        /* Inline reply and quote forms */
        .reply-form, .quote-form {
          margin: 10px 0;
          padding: 10px;
          border-top: 1px solid var(--twitter-extra-light-gray);
        }
        
        .reply-input-container, .quote-input-container {
          display: flex;
          flex-direction: column;
          gap: 10px;
        }
        
        .reply-textarea, .quote-textarea {
          width: 100%;
          min-height: 80px;
          padding: 10px;
          border: 1px solid var(--twitter-light-gray);
          border-radius: 8px;
          resize: none;
          font-family: inherit;
          font-size: 1rem;
        }
        
        .reply-actions, .quote-actions {
          display: flex;
          justify-content: space-between;
          align-items: center;
        }
        
        .reply-submit-btn, .quote-submit-btn {
          background-color: var(--twitter-blue);
          color: white;
          border: none;
          border-radius: 50px;
          padding: 8px 16px;
          font-weight: bold;
          cursor: pointer;
        }
        
        .reply-cancel-btn, .quote-cancel-btn {
          background-color: transparent;
          color: var(--twitter-dark-gray);
          border: 1px solid var(--twitter-light-gray);
          border-radius: 50px;
          padding: 8px 16px;
          margin-right: 10px;
          cursor: pointer;
        }
        
        .quoted-preview {
          padding: 10px;
          border: 1px solid var(--twitter-light-gray);
          border-radius: 8px;
          background-color: rgba(0, 0, 0, 0.02);
          margin: 5px 0;
        }
        
        body.dark-mode .reply-textarea,
        body.dark-mode .quote-textarea {
          background-color: #253341;
          color: white;
          border-color: #38444d;
        }
        
        body.dark-mode .quoted-preview {
          background-color: rgba(255, 255, 255, 0.05);
          border-color: #38444d;
        }
      `;
      document.head.appendChild(style);
      
      // Fetch tweets initially
      fetchAndRenderTweets();
    });

    // Make sure to add event listeners after the tweets are rendered
    function addEventListeners() {
      // Find all tweet buttons and add event listeners directly to them
      document.querySelectorAll('.tweet-card').forEach(tweet => {
        const tweetId = tweet.getAttribute('data-tweet-id');
        
        // Reply button
        const replyBtn = tweet.querySelector('.reply-btn');
        if (replyBtn) {
          replyBtn.onclick = function(e) {
            e.preventDefault();
            showReplyModal(tweetId);
          };
        }
        
        // Retweet button
        const retweetBtn = tweet.querySelector('.retweet-btn');
        if (retweetBtn) {
          retweetBtn.onclick = function(e) {
            e.preventDefault();
            retweetTweet(tweetId);
          };
        }
        
        // Like button
        const likeBtn = tweet.querySelector('.like-btn');
        if (likeBtn) {
          likeBtn.onclick = function(e) {
            e.preventDefault();
            likeTweet(tweetId);
          };
        }
        
        // Share/Quote button
        const shareBtn = tweet.querySelector('.share-btn');
        if (shareBtn) {
          shareBtn.onclick = function(e) {
            e.preventDefault();
            showShareTweet(tweetId);
          };
        }
      });
    }

    // Implement retweet functionality
    async function retweetTweet(tweetId) {
      if (!currentUser) {
        alert("Please log in to retweet");
        return;
      }
      
      try {
        const response = await fetch('/api/tweet/retweet', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            tweetId: parseInt(tweetId),
            handle: currentUser
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Update retweet count in UI without refreshing the whole feed
          const retweetBtn = document.querySelector(`.tweet-card[data-tweet-id="${tweetId}"] .retweet-btn`);
          const retweetCount = retweetBtn.querySelector("span");
          
          // If count exists, increment it
          if (retweetCount) {
            const currentCount = parseInt(retweetCount.textContent || 0);
            retweetCount.textContent = currentCount + 1;
          }
          
          // Add visual feedback
          const retweetIcon = retweetBtn.querySelector("i");
          retweetBtn.classList.add("retweeted");
          retweetIcon.style.color = "#17bf63";
          
          // Refresh the feed to show the retweeted tweet at the top
          fetchAndRenderTweets();
        } else {
          alert('Error retweeting: ' + (data.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error retweeting:', error);
        alert('Error retweeting. Please try again.');
      }
    }

    // Handle quote tweet functionality
    async function handleQuoteTweet(tweetId) {
      try {
        // Get the original tweet data
        const tweet = await fetchTweet(tweetId);
        if (!tweet) {
          alert('Error: Could not load tweet to quote');
          return;
        }

        // Create a modal or form for quoting
        const quoteModal = document.createElement('div');
        quoteModal.className = 'quote-modal';
        quoteModal.innerHTML = `
          <div class="quote-modal-content">
            <h3>Quote Tweet</h3>
            <div class="quoted-tweet">
              <div class="tweet-header">
                <img src="${tweet.profilePicture || 'default-profile.png'}" alt="${tweet.handle}" class="profile-pic">
                <div class="tweet-header-info">
                  <span class="name">${tweet.handle}</span>
                  ${tweet.verified ? '<span class="verified">✓</span>' : ''}
                  <span class="handle">@${tweet.handle}</span>
                </div>
              </div>
              <div class="tweet-text">${tweet.text}</div>
            </div>
            <textarea id="quote-text" placeholder="Add a comment..."></textarea>
            <div class="modal-buttons">
              <button id="cancel-quote">Cancel</button>
              <button id="submit-quote">Tweet</button>
            </div>
          </div>
        `;
        
        document.body.appendChild(quoteModal);
        
        // Add event listeners for the modal buttons
        document.getElementById('cancel-quote').addEventListener('click', () => {
          quoteModal.remove();
        });
        
        document.getElementById('submit-quote').addEventListener('click', async () => {
          const quoteText = document.getElementById('quote-text').value;
          if (!quoteText.trim()) {
            alert('Please add a comment to your quote tweet');
            return;
          }
          
          try {
            const response = await fetch('/api/tweet', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                handle: currentUser,
                text: quoteText,
                quotedTweet: {
                  id: tweet.id,
                  handle: tweet.handle,
                  text: tweet.text,
                  timestamp: tweet.timestamp
                }
              })
            });
            
            const data = await response.json();
            
            if (data.success) {
              quoteModal.remove();
              // Refresh the feed to show the new quote tweet
              fetchAndRenderTweets();
            } else {
              alert('Error posting quote tweet: ' + (data.error || 'Unknown error'));
            }
          } catch (error) {
            console.error('Error posting quote tweet:', error);
            alert('Error posting quote tweet. Please try again.');
          }
        });
        
      } catch (error) {
        console.error('Error handling quote tweet:', error);
        alert('Error preparing quote tweet. Please try again.');
      }
    }

    // Function to fetch a single tweet by ID
    async function fetchTweet(tweetId) {
      try {
        const response = await fetch('/api/tweets');
        const data = await response.json();
        if (data.success) {
          return data.tweets.find(tweet => tweet.id === parseInt(tweetId));
        }
        return null;
      } catch (error) {
        console.error('Error fetching tweet:', error);
        return null;
      }
    }

    // Handle reply functionality
    async function handleReply(tweetId) {
      try {
        // Get the tweet card element
        const tweetCard = document.querySelector(`.tweet-card[data-tweet-id="${tweetId}"]`);
        
        // Check if reply form already exists
        let replyForm = tweetCard.querySelector('.reply-form');
        
        if (replyForm) {
          // Toggle visibility if form already exists
          replyForm.style.display = replyForm.style.display === 'none' ? 'block' : 'none';
          return;
        }
        
        // Create reply form
        replyForm = document.createElement('div');
        replyForm.className = 'reply-form';
        replyForm.innerHTML = `
          <textarea class="reply-text" placeholder="Tweet your reply"></textarea>
          <div class="reply-form-actions">
            <button class="cancel-reply-btn">Cancel</button>
            <button class="submit-reply-btn">Reply</button>
          </div>
        `;
        
        // Add reply form after the tweet content
        const tweetContent = tweetCard.querySelector('.tweet-body');
        tweetContent.after(replyForm);
        
        // Focus on the textarea
        replyForm.querySelector('.reply-text').focus();
        
        // Add event listeners for the reply form buttons
        replyForm.querySelector('.cancel-reply-btn').addEventListener('click', () => {
          replyForm.remove();
        });
        
        replyForm.querySelector('.submit-reply-btn').addEventListener('click', async () => {
          const replyText = replyForm.querySelector('.reply-text').value;
          if (!replyText) return;
          
          try {
            const response = await fetch('/api/tweet/reply', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                tweetId: parseInt(tweetId),
                handle: currentUser,
                text: replyText
              })
            });
            
            const data = await response.json();
            
            if (data.success) {
              // Remove the reply form
              replyForm.remove();
              
              // Render the new reply
              const repliesSection = tweetCard.querySelector('.replies-section') || 
                                    createRepliesSection(tweetCard);
              
              addReplyToUI(repliesSection, data.reply);
              
              // Update reply count in UI
              const replyBtn = tweetCard.querySelector('.reply-btn');
              const replyCount = replyBtn.querySelector("span");
              
              if (replyCount) {
                const currentCount = parseInt(replyCount.textContent || 0);
                replyCount.textContent = currentCount + 1;
              } else {
                // Create count element if it doesn't exist
                const countSpan = document.createElement('span');
                countSpan.textContent = '1';
                replyBtn.appendChild(countSpan);
              }
            } else {
              alert('Error posting reply: ' + (data.error || 'Unknown error'));
            }
          } catch (error) {
            console.error('Error posting reply:', error);
            alert('Error posting reply. Please try again.');
          }
        });
      } catch (error) {
        console.error('Error handling reply:', error);
        alert('Error preparing reply. Please try again.');
      }
    }

    // Create replies section if it doesn't exist
    function createRepliesSection(tweetCard) {
      const repliesSection = document.createElement('div');
      repliesSection.className = 'replies-section';
      tweetCard.appendChild(repliesSection);
      return repliesSection;
    }

    // Add a reply to the UI
    function addReplyToUI(repliesSection, reply) {
      const replyElement = document.createElement('div');
      replyElement.className = 'reply';
      replyElement.innerHTML = `
        <div class="reply-header">
          <img src="${reply.profilePicture || 'default-profile.png'}" alt="${reply.handle}" class="profile-pic-small">
          <div class="reply-header-info">
            <span class="name">${reply.handle}</span>
            ${reply.verified ? '<span class="verified">✓</span>' : ''}
            <span class="handle">@${reply.handle}</span>
          </div>
        </div>
        <div class="reply-text">${reply.text}</div>
        <div class="reply-actions">
          <span class="reply-like">❤️ <span class="reply-like-count">${reply.likes || 0}</span></span>
        </div>
      `;
      
      // Add event listener for reply like button
      replyElement.querySelector('.reply-like').addEventListener('click', async () => {
        const likeCount = replyElement.querySelector('.reply-like-count');
        const currentLikes = parseInt(likeCount.textContent);
        const newLikes = currentLikes + 1;
        
        try {
          const response = await fetch('/api/tweet/reply/like', {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              tweetId: parseInt(replyElement.closest('.tweet-card').dataset.tweetId),
              replyId: reply.id,
              likes: newLikes
            })
          });
          
          const data = await response.json();
          
          if (data.success) {
            likeCount.textContent = newLikes;
          }
        } catch (error) {
          console.error('Error liking reply:', error);
        }
      });
      
      repliesSection.appendChild(replyElement);
    }

    // Add event listeners for quote and reply buttons to all tweets when rendering
    function addTweetActionListeners(tweetCard) {
      const tweetId = tweetCard.dataset.tweetId;
      
      // Add quote button listener
      const quoteBtn = tweetCard.querySelector('.quote-btn');
      if (quoteBtn) {
        quoteBtn.addEventListener('click', () => handleQuoteTweet(tweetId));
      }
      
      // Add reply button listener
      const replyBtn = tweetCard.querySelector('.reply-btn');
      if (replyBtn) {
        replyBtn.addEventListener('click', () => handleReply(tweetId));
      }
      
      // Keep existing retweet button listener
      const retweetBtn = tweetCard.querySelector('.retweet-btn');
      if (retweetBtn) {
        retweetBtn.addEventListener('click', () => handleRetweet(tweetId));
      }
    }

    // Modify the createTweetCard function to add event listeners when creating tweet cards
    function createTweetCard(tweet) {
      const tweetCard = document.createElement('div');
      tweetCard.className = 'tweet-card';
      tweetCard.dataset.tweetId = tweet.id;
      
      // Add handle and verification status
      const handleDiv = document.createElement('div');
      handleDiv.className = 'tweet-header';
      
      // Add profile picture if available
      if (tweet.profilePicture) {
        const profilePic = document.createElement('img');
        profilePic.className = 'profile-pic';
        profilePic.src = tweet.profilePicture;
        profilePic.alt = tweet.handle;
        handleDiv.appendChild(profilePic);
      } else {
        const defaultProfilePic = document.createElement('div');
        defaultProfilePic.className = 'default-profile-pic';
        defaultProfilePic.innerHTML = '<i class="fas fa-user"></i>';
        handleDiv.appendChild(defaultProfilePic);
      }
      
      const handleContent = document.createElement('div');
      handleContent.className = 'handle-content';
      
      const handleSpan = document.createElement('span');
      handleSpan.className = 'tweet-handle';
      handleSpan.textContent = tweet.handle;
      
      // Add verification badge if the user is verified
      if (tweet.verified) {
        const verifiedBadge = document.createElement('span');
        verifiedBadge.className = 'verified-badge';
        verifiedBadge.innerHTML = '<i class="fas fa-check-circle"></i>';
        verifiedBadge.title = tweet.verified === 'gold' ? 'Gold Verified' : 'Blue Verified';
        verifiedBadge.style.color = tweet.verified === 'gold' ? 'gold' : '#1DA1F2';
        handleSpan.appendChild(verifiedBadge);
      }
      
      handleContent.appendChild(handleSpan);
      handleDiv.appendChild(handleContent);
      
      // Add timestamp
      const timestamp = document.createElement('span');
      timestamp.className = 'tweet-timestamp';
      const date = new Date(tweet.timestamp);
      timestamp.textContent = date.toLocaleString();
      handleContent.appendChild(timestamp);
      
      tweetCard.appendChild(handleDiv);
      
      // Add retweet banner if applicable
      if (tweet.last_retweeted_by) {
        const retweetBanner = document.createElement('div');
        retweetBanner.className = 'retweet-banner';
        retweetBanner.innerHTML = `<i class="fas fa-retweet"></i> Retweeted by ${tweet.last_retweeted_by}`;
        tweetCard.appendChild(retweetBanner);
      }
      
      // Add tweet text
      const tweetText = document.createElement('div');
      tweetText.className = 'tweet-text';
      tweetText.textContent = tweet.text;
      tweetCard.appendChild(tweetText);
      
      // Add image if available
      if (tweet.imageData) {
        const tweetImage = document.createElement('img');
        tweetImage.className = 'tweet-image';
        tweetImage.src = tweet.imageData;
        tweetImage.alt = 'Tweet image';
        tweetCard.appendChild(tweetImage);
      }
      
      // Add quoted tweet if available
      if (tweet.quotedTweet) {
        const quotedTweet = document.createElement('div');
        quotedTweet.className = 'quoted-tweet';
        
        const quotedHeader = document.createElement('div');
        quotedHeader.className = 'tweet-header';
        
        // Add profile picture if available for quoted tweet
        if (tweet.quotedTweet.profilePicture) {
          const quotedProfilePic = document.createElement('img');
          quotedProfilePic.className = 'profile-pic-small';
          quotedProfilePic.src = tweet.quotedTweet.profilePicture;
          quotedProfilePic.alt = tweet.quotedTweet.handle;
          quotedHeader.appendChild(quotedProfilePic);
        } else {
          const quotedDefaultProfilePic = document.createElement('div');
          quotedDefaultProfilePic.className = 'default-profile-pic-small';
          quotedDefaultProfilePic.innerHTML = '<i class="fas fa-user"></i>';
          quotedHeader.appendChild(quotedDefaultProfilePic);
        }
        
        const quotedHandleContent = document.createElement('div');
        quotedHandleContent.className = 'handle-content';
        
        const quotedHandleSpan = document.createElement('span');
        quotedHandleSpan.className = 'tweet-handle';
        quotedHandleSpan.textContent = tweet.quotedTweet.handle;
        
        // Add verification badge if the quoted user is verified
        if (tweet.quotedTweet.verified) {
          const quotedVerifiedBadge = document.createElement('span');
          quotedVerifiedBadge.className = 'verified-badge';
          quotedVerifiedBadge.innerHTML = '<i class="fas fa-check-circle"></i>';
          quotedVerifiedBadge.title = tweet.quotedTweet.verified === 'gold' ? 'Gold Verified' : 'Blue Verified';
          quotedVerifiedBadge.style.color = tweet.quotedTweet.verified === 'gold' ? 'gold' : '#1DA1F2';
          quotedHandleSpan.appendChild(quotedVerifiedBadge);
        }
        
        quotedHandleContent.appendChild(quotedHandleSpan);
        quotedHeader.appendChild(quotedHandleContent);
        
        quotedTweet.appendChild(quotedHeader);
        
        const quotedText = document.createElement('div');
        quotedText.className = 'tweet-text';
        quotedText.textContent = tweet.quotedTweet.text;
        quotedTweet.appendChild(quotedText);
        
        tweetCard.appendChild(quotedTweet);
      }
      
      // Add poll if available
      if (tweet.poll) {
        const pollDiv = document.createElement('div');
        pollDiv.className = 'poll-container';
        
        // Add poll options
        tweet.poll.options.forEach(option => {
          const optionDiv = document.createElement('div');
          optionDiv.className = 'poll-option';
          
          const optionText = document.createElement('span');
          optionText.className = 'poll-option-text';
          optionText.textContent = option.text;
          
          const optionVotes = document.createElement('span');
          optionVotes.className = 'poll-option-votes';
          optionVotes.textContent = `${option.votes} votes`;
          
          optionDiv.appendChild(optionText);
          optionDiv.appendChild(optionVotes);
          
          // Make poll options clickable
          optionDiv.addEventListener('click', async () => {
            try {
              const response = await fetch('/api/tweet/poll/vote', {
                method: 'PATCH',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  id: tweet.id,
                  option: option.text
                })
              });
              
              const data = await response.json();
              if (data.success) {
                optionVotes.textContent = `${option.votes + 1} votes`;
              }
            } catch (error) {
              console.error('Error voting on poll:', error);
            }
          });
          
          pollDiv.appendChild(optionDiv);
        });
        
        tweetCard.appendChild(pollDiv);
      }
      
      // Add community notes if available
      if (tweet.communityNotes && tweet.communityNotes.length > 0) {
        const notesContainer = document.createElement('div');
        notesContainer.className = 'community-notes-container';
        
        tweet.communityNotes.forEach(note => {
          const noteDiv = document.createElement('div');
          noteDiv.className = 'community-note';
          
          const noteText = document.createElement('div');
          noteText.className = 'community-note-text';
          noteText.innerHTML = `<i class="fas fa-info-circle"></i> <strong>Community Note:</strong> ${note.text}`;
          
          noteDiv.appendChild(noteText);
          notesContainer.appendChild(noteDiv);
        });
        
        tweetCard.appendChild(notesContainer);
      }
      
      // Add tweet actions (like, retweet, etc.)
      const actionsDiv = document.createElement('div');
      actionsDiv.className = 'tweet-actions';
      
      // Like button
      const likeButton = document.createElement('button');
      likeButton.className = 'tweet-action-button like-button';
      likeButton.innerHTML = '<i class="far fa-heart"></i> <span class="like-count">' + tweet.likes + '</span>';
      likeButton.dataset.liked = 'false';
      
      likeButton.addEventListener('click', async function(e) {
        e.stopPropagation(); // Prevent opening the tweet detail view
        const isLiked = this.dataset.liked === 'true';
        const likeCount = parseInt(this.querySelector('.like-count').textContent);
        const newLikeCount = isLiked ? likeCount - 1 : likeCount + 1;
        
        try {
          const response = await fetch('/api/tweet/like', {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              id: tweet.id,
              likes: newLikeCount
            })
          });
          
          const data = await response.json();
          if (data.success) {
            this.querySelector('.like-count').textContent = newLikeCount;
            this.dataset.liked = isLiked ? 'false' : 'true';
            this.querySelector('i').className = isLiked ? 'far fa-heart' : 'fas fa-heart';
            
            if (isLiked) {
              this.querySelector('i').style.color = '';
            } else {
              this.querySelector('i').style.color = 'red';
            }
          }
        } catch (error) {
          console.error('Error liking tweet:', error);
        }
      });
      
      actionsDiv.appendChild(likeButton);
      
      // Retweet button
      const retweetButton = document.createElement('button');
      retweetButton.className = 'tweet-action-button retweet-button';
      retweetButton.innerHTML = '<i class="fas fa-retweet"></i>';
      
      retweetButton.addEventListener('click', async (e) => {
        e.stopPropagation(); // Prevent opening the tweet detail view
        const loggedInHandle = localStorage.getItem('handle');
        if (!loggedInHandle) {
          alert('You must be logged in to retweet');
          return;
        }
        
        try {
          const response = await fetch('/api/tweet/retweet', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              tweetId: tweet.id,
              handle: loggedInHandle
            })
          });
          
          const data = await response.json();
          if (data.success) {
            alert('Retweeted successfully!');
            // Refresh tweets
            loadTweets();
          }
        } catch (error) {
          console.error('Error retweeting:', error);
        }
      });
      
      actionsDiv.appendChild(retweetButton);
      
      // Quote button
      const quoteButton = document.createElement('button');
      quoteButton.className = 'tweet-action-button quote-button';
      quoteButton.innerHTML = '<i class="fas fa-quote-right"></i>';
      
      quoteButton.addEventListener('click', (e) => {
        e.stopPropagation(); // Prevent opening the tweet detail view
        const loggedInHandle = localStorage.getItem('handle');
        if (!loggedInHandle) {
          alert('You must be logged in to quote tweet');
          return;
        }
        
        // Create quote modal
        const modal = document.createElement('div');
        modal.className = 'quote-modal';
        
        const modalContent = document.createElement('div');
        modalContent.className = 'quote-modal-content';
        
        const quotedTweetDiv = document.createElement('div');
        quotedTweetDiv.className = 'quoted-tweet';
        quotedTweetDiv.innerHTML = `
          <div class="tweet-header">
            <span class="tweet-handle">${tweet.handle}</span>
          </div>
          <div class="tweet-text">${tweet.text}</div>
        `;
        
        const quoteTextarea = document.createElement('textarea');
        quoteTextarea.id = 'quote-text';
        quoteTextarea.placeholder = 'Add a comment...';
        
        const buttonContainer = document.createElement('div');
        buttonContainer.className = 'modal-buttons';
        
        const cancelButton = document.createElement('button');
        cancelButton.id = 'cancel-quote';
        cancelButton.textContent = 'Cancel';
        cancelButton.addEventListener('click', () => {
          document.body.removeChild(modal);
        });
        
        const submitButton = document.createElement('button');
        submitButton.id = 'submit-quote';
        submitButton.textContent = 'Quote';
        submitButton.addEventListener('click', async () => {
          const quoteText = quoteTextarea.value.trim();
          
          try {
            const response = await fetch('/api/tweet', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                handle: loggedInHandle,
                text: quoteText,
                quotedTweet: {
                  id: tweet.id,
                  handle: tweet.handle,
                  text: tweet.text
                }
              })
            });
            
            const data = await response.json();
            if (data.success) {
              document.body.removeChild(modal);
              loadTweets();
            }
          } catch (error) {
            console.error('Error posting quote tweet:', error);
          }
        });
        
        buttonContainer.appendChild(cancelButton);
        buttonContainer.appendChild(submitButton);
        
        modalContent.appendChild(quotedTweetDiv);
        modalContent.appendChild(quoteTextarea);
        modalContent.appendChild(buttonContainer);
        
        modal.appendChild(modalContent);
        document.body.appendChild(modal);
        
        quoteTextarea.focus();
        
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            document.body.removeChild(modal);
          }
        });
      });
      
      actionsDiv.appendChild(quoteButton);
      
      // Reply button with count
      const replyButton = document.createElement('button');
      replyButton.className = 'tweet-action-button reply-button';
      
      // Add reply count
      const replyCount = tweet.replies ? tweet.replies.length : 0;
      replyButton.innerHTML = `
        <i class="fas fa-reply"></i>
        <span class="reply-count">${replyCount}</span>
      `;
      replyButton.title = 'Reply';
      
      replyButton.addEventListener('click', function(e) {
        e.stopPropagation(); // Prevent opening the tweet detail view
        const loggedInHandle = localStorage.getItem('handle');
        if (!loggedInHandle) {
          alert('You must be logged in to reply');
          return;
        }
        
        // Check if a reply form already exists
        let replySection = tweetCard.querySelector('.replies-section');
        if (!replySection) {
          replySection = document.createElement('div');
          replySection.className = 'replies-section';
          tweetCard.appendChild(replySection);
        }
        
        // Check if the form is already open
        let replyForm = replySection.querySelector('.reply-form-container');
        if (replyForm) {
          // Toggle the form
          replyForm.remove();
          return;
        }
        
        // Create a reply form
        replyForm = document.createElement('div');
        replyForm.className = 'reply-form-container';
        
        const replyingTo = document.createElement('div');
        replyingTo.className = 'replying-to';
        replyingTo.textContent = `Replying to @${tweet.handle}`;
        replyForm.appendChild(replyingTo);
        
        const textarea = document.createElement('textarea');
        textarea.className = 'reply-text';
        textarea.placeholder = 'Tweet your reply';
        replyForm.appendChild(textarea);
        
        const buttonContainer = document.createElement('div');
        buttonContainer.className = 'reply-form-actions';
        
        const cancelButton = document.createElement('button');
        cancelButton.className = 'cancel-reply-btn';
        cancelButton.textContent = 'Cancel';
        cancelButton.addEventListener('click', (e) => {
          e.stopPropagation(); // Prevent opening the tweet detail view
          replyForm.remove();
        });
        
        const submitButton = document.createElement('button');
        submitButton.className = 'submit-reply-btn';
        submitButton.textContent = 'Reply';
        submitButton.disabled = true;
        
        // Enable/disable submit button based on input
        textarea.addEventListener('input', () => {
          submitButton.disabled = textarea.value.trim() === '';
        });
        
        submitButton.addEventListener('click', async (e) => {
          e.stopPropagation(); // Prevent opening the tweet detail view
          const replyText = textarea.value.trim();
          if (!replyText) return;
          
          try {
            const response = await fetch('/api/tweet/reply', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                tweetId: tweet.id,
                handle: loggedInHandle,
                text: replyText
              })
            });
            
            const data = await response.json();
            if (data.success) {
              // Add the new reply to the UI
              const newReply = createReplyElement(data.reply);
              
              // Find or create the replies list
              let repliesList = replySection.querySelector('.replies-list');
              if (!repliesList) {
                repliesList = document.createElement('div');
                repliesList.className = 'replies-list';
                replySection.appendChild(repliesList);
              }
              
              // Add the new reply to the beginning of the list
              repliesList.insertBefore(newReply, repliesList.firstChild);
              
              // Update reply count in the button
              const currentCount = parseInt(replyButton.querySelector('.reply-count').textContent);
              replyButton.querySelector('.reply-count').textContent = currentCount + 1;
              
              // Update reply count header
              const replyCountHeader = replySection.querySelector('.reply-count-header');
              if (replyCountHeader) {
                const newCount = currentCount + 1;
                replyCountHeader.textContent = `${newCount} ${newCount === 1 ? 'Reply' : 'Replies'}`;
              }
              
              // Remove the reply form
              replyForm.remove();
            } else {
              alert('Error posting reply: ' + data.error);
            }
          } catch (error) {
            console.error('Error posting reply:', error);
            alert('Error posting reply');
          }
        });
        
        buttonContainer.appendChild(cancelButton);
        buttonContainer.appendChild(submitButton);
        replyForm.appendChild(buttonContainer);
        
        // Add the form to the replies section
        replySection.insertBefore(replyForm, replySection.firstChild);
        
        // Focus on the textarea
        textarea.focus();
      });
      
      actionsDiv.appendChild(replyButton);
      
      // Views counter
      if (tweet.views) {
        const viewsCounter = document.createElement('span');
        viewsCounter.className = 'views-counter';
        viewsCounter.innerHTML = `<i class="far fa-eye"></i> ${tweet.views} views`;
        actionsDiv.appendChild(viewsCounter);
      }
      
      tweetCard.appendChild(actionsDiv);
      
      // Always add replies section
      const repliesSection = document.createElement('div');
      repliesSection.className = 'replies-section';
      
      // Create a reply count header
      const replyCountHeader = document.createElement('div');
      replyCountHeader.className = 'reply-count-header';
      replyCountHeader.textContent = replyCount > 0 ? 
        `${replyCount} ${replyCount === 1 ? 'Reply' : 'Replies'}` : 
        'No replies yet';
      repliesSection.appendChild(replyCountHeader);
      
      // Always add replies list even if empty
      const repliesList = document.createElement('div');
      repliesList.className = 'replies-list';
      
      // Add existing replies if any
      if (tweet.replies && tweet.replies.length > 0) {
        // Sort replies by timestamp (newest first)
        const sortedReplies = [...tweet.replies].sort((a, b) => b.timestamp - a.timestamp);
        
        sortedReplies.forEach(reply => {
          const replyElement = createReplyElement(reply);
          repliesList.appendChild(replyElement);
        });
      }
      
      repliesSection.appendChild(repliesList);
      tweetCard.appendChild(repliesSection);
      
      console.log(`Created tweet card for tweet ${tweet.id} with ${replyCount} replies`);
      
      return tweetCard;
    }
    
    // Function to create a reply element
    function createReplyElement(reply) {
      const replyElement = document.createElement('div');
      replyElement.className = 'reply';
      replyElement.dataset.replyId = reply.id;
      
      const replyHeader = document.createElement('div');
      replyHeader.className = 'reply-header';
      
      // Add profile picture if available
      if (reply.profilePicture) {
        const profilePic = document.createElement('img');
        profilePic.className = 'profile-pic-small';
        profilePic.src = reply.profilePicture;
        profilePic.alt = reply.handle;
        replyHeader.appendChild(profilePic);
      } else {
        const defaultProfilePic = document.createElement('div');
        defaultProfilePic.className = 'default-profile-pic-small';
        defaultProfilePic.innerHTML = '<i class="fas fa-user"></i>';
        replyHeader.appendChild(defaultProfilePic);
      }
      
      const handleContent = document.createElement('div');
      handleContent.className = 'handle-content';
      
      const handleSpan = document.createElement('span');
      handleSpan.className = 'reply-handle';
      handleSpan.textContent = reply.handle;
      
      // Add verification badge if the user is verified
      if (reply.verified) {
        const verifiedBadge = document.createElement('span');
        verifiedBadge.className = 'verified-badge';
        verifiedBadge.innerHTML = '<i class="fas fa-check-circle"></i>';
        verifiedBadge.title = reply.verified === 'gold' ? 'Gold Verified' : 'Blue Verified';
        verifiedBadge.style.color = reply.verified === 'gold' ? 'gold' : '#1DA1F2';
        handleSpan.appendChild(verifiedBadge);
      }
      
      handleContent.appendChild(handleSpan);
      
      // Add timestamp
      const timestamp = document.createElement('span');
      timestamp.className = 'reply-timestamp';
      const date = new Date(reply.timestamp);
      timestamp.textContent = date.toLocaleString();
      handleContent.appendChild(timestamp);
      
      replyHeader.appendChild(handleContent);
      replyElement.appendChild(replyHeader);
      
      // Add reply text
      const replyText = document.createElement('div');
      replyText.className = 'reply-text-content';
      replyText.textContent = reply.text;
      replyElement.appendChild(replyText);
      
      // Add image if available
      if (reply.imageData) {
        const replyImage = document.createElement('img');
        replyImage.className = 'reply-image';
        replyImage.src = reply.imageData;
        replyImage.alt = 'Reply image';
        replyElement.appendChild(replyImage);
      }
      
      // Add reply actions (like)
      const replyActions = document.createElement('div');
      replyActions.className = 'reply-actions';
      
      const replyLike = document.createElement('span');
      replyLike.className = 'reply-like';
      replyLike.innerHTML = `<i class="far fa-heart"></i> <span>${reply.likes || 0}</span>`;
      replyLike.dataset.liked = 'false';
      
      replyLike.addEventListener('click', async function() {
        const isLiked = this.dataset.liked === 'true';
        const likeCount = parseInt(this.querySelector('span').textContent);
        const newLikeCount = isLiked ? likeCount - 1 : likeCount + 1;
        
        try {
          const response = await fetch('/api/tweet/reply/like', {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              tweetId: parseInt(replyElement.closest('.tweet-card').dataset.tweetId),
              replyId: reply.id,
              likes: newLikeCount
            })
          });
          
          const data = await response.json();
          if (data.success) {
            this.querySelector('span').textContent = newLikeCount;
            this.dataset.liked = isLiked ? 'false' : 'true';
            this.querySelector('i').className = isLiked ? 'far fa-heart' : 'fas fa-heart';
            
            if (isLiked) {
              this.querySelector('i').style.color = '';
            } else {
              this.querySelector('i').style.color = 'red';
            }
          }
        } catch (error) {
          console.error('Error liking reply:', error);
        }
      });
      
      replyActions.appendChild(replyLike);
      replyElement.appendChild(replyActions);
      
      return replyElement;
    }
    
    // Function to load tweets from the server
    async function loadTweets() {
      try {
        console.log('Loading tweets...');
        
        const response = await fetch('/api/tweets');
        const data = await response.json();
        
        if (!data.success) {
          console.error('Error loading tweets:', data.error);
          return;
        }
        
        // Store all tweets in a global variable for reference
        window.allTweets = data.tweets;
        const tweets = data.tweets;
        console.log(`Loaded ${tweets.length} tweets`);
        
        // Get the tweets container
        const tweetsContainer = document.getElementById('tweets-container');
        tweetsContainer.innerHTML = '';
        
        // Sort tweets by timestamp (newest first)
        tweets.sort((a, b) => b.timestamp - a.timestamp);
        
        // Render each tweet
        tweets.forEach(tweet => {
          // Create tweet card
          const tweetCard = document.createElement('div');
          tweetCard.className = 'card mb-3 tweet-card';
          tweetCard.dataset.tweetId = tweet.id;
          
          // Check if this is a retweet
          const isRetweet = tweet.last_retweeted_by !== null;
          
          // Create tweet content
          let cardContent = '';
          
          // Add retweet header if necessary
          if (isRetweet) {
            cardContent += `
              <div class="card-header bg-transparent text-muted small">
                <i class="fas fa-retweet"></i> Retweeted by ${tweet.last_retweeted_by}
              </div>
            `;
          }
          
          // Add tweet body
          cardContent += `
            <div class="card-body">
              <div class="d-flex">
                <img src="${tweet.profilePicture || 'https://via.placeholder.com/50'}" class="rounded-circle mr-3" width="50" height="50">
                <div class="w-100">
                  <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title m-0">${tweet.handle} ${tweet.verified ? '<i class="fas fa-check-circle text-primary"></i>' : ''}</h5>
                    <span class="text-muted small">${formatDate(tweet.timestamp)}</span>
                  </div>
                  <p class="card-text">${tweet.text}</p>
          `;
          
          // Add image if present
          if (tweet.imageData) {
            cardContent += `<img src="${tweet.imageData}" class="img-fluid rounded mb-3" alt="Tweet image">`;
          }
          
          // Add poll if present
          if (tweet.poll) {
            cardContent += `
              <div class="card mb-3">
                <div class="card-body">
                  <h6 class="card-subtitle mb-2 text-muted">Poll</h6>
                  <div class="poll-options">
            `;
            
            // Calculate total votes
            const totalVotes = tweet.poll.options.reduce((total, option) => total + option.votes, 0);
            
            // Add options
            tweet.poll.options.forEach(option => {
              const percentage = totalVotes > 0 ? Math.round((option.votes / totalVotes) * 100) : 0;
              
              cardContent += `
                <div class="mb-2">
                  <div class="d-flex justify-content-between">
                    <span>${option.text}</span>
                    <span>${percentage}%</span>
                  </div>
                  <div class="progress">
                    <div class="progress-bar" role="progressbar" style="width: ${percentage}%" aria-valuenow="${percentage}" aria-valuemin="0" aria-valuemax="100"></div>
                  </div>
                  <div class="small text-muted">${option.votes} votes</div>
                </div>
              `;
            });
            
            cardContent += `
                    <div class="mt-2 text-muted small">${totalVotes} votes · Poll ends in 3 days</div>
                  </div>
                </div>
              </div>
            `;
          }
          
          // Add quoted tweet if present
          if (tweet.quotedTweet) {
            cardContent += `
              <div class="card mb-3">
                <div class="card-body">
                  <div class="d-flex">
                    <img src="${tweet.quotedTweet.profilePicture || 'https://via.placeholder.com/30'}" class="rounded-circle mr-2" width="30" height="30">
                    <div>
                      <div class="font-weight-bold">${tweet.quotedTweet.handle} ${tweet.quotedTweet.verified ? '<i class="fas fa-check-circle text-primary"></i>' : ''}</div>
                      <div>${tweet.quotedTweet.text}</div>
                    </div>
                  </div>
                </div>
              </div>
            `;
          }
          
          // Add community notes if present
          if (tweet.communityNotes && tweet.communityNotes.length > 0) {
            cardContent += `
              <div class="card bg-light mb-3">
                <div class="card-body">
                  <h6 class="card-subtitle mb-2 text-muted"><i class="fas fa-info-circle"></i> Community Notes</h6>
                  <div class="notes-container">
            `;
            
            tweet.communityNotes.forEach(note => {
              cardContent += `
                <div class="note-item mb-2">
                  <p class="mb-1">${note.text}</p>
                  <div class="text-muted small">${formatDate(note.timestamp)}</div>
                </div>
              `;
            });
            
            cardContent += `
                  </div>
                </div>
              </div>
            `;
          }
          
          // Add tweet stats and action buttons
          cardContent += `
                  <div class="d-flex justify-content-between text-muted mt-3">
                    <div>
                      <button class="btn btn-sm btn-link text-muted reply-btn">
                        <i class="far fa-comment"></i> ${tweet.replies ? tweet.replies.length : 0}
                      </button>
                    </div>
                    <div>
                      <button class="btn btn-sm btn-link text-muted retweet-btn" data-id="${tweet.id}">
                        <i class="fas fa-retweet"></i>
                      </button>
                    </div>
                    <div>
                      <button class="btn btn-sm btn-link text-muted like-btn ${tweet.likes > 0 ? 'liked' : ''}" data-id="${tweet.id}" data-likes="${tweet.likes}">
                        <i class="${tweet.likes > 0 ? 'fas' : 'far'} fa-heart"></i> ${tweet.likes}
                      </button>
                    </div>
                    <div>
                      <button class="btn btn-sm btn-link text-muted quote-btn" data-id="${tweet.id}">
                        <i class="fas fa-quote-right"></i>
                      </button>
                    </div>
                    <div>
                      <button class="btn btn-sm btn-link text-muted">
                        <i class="far fa-chart-bar"></i> ${tweet.views || '0'}
                      </button>
                    </div>
                    <div>
                      <button class="btn btn-sm btn-link text-muted bookmark-btn" data-id="${tweet.id}">
                        <i class="far fa-bookmark"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;
          
          // Add replies if any
          if (tweet.replies && tweet.replies.length > 0) {
            cardContent += `<div class="card-footer bg-white">`;
            
            // Sort replies by number of likes (most liked first)
            const sortedReplies = [...tweet.replies].sort((a, b) => b.likes - a.likes);
            
            // Only show top 3 replies
            const topReplies = sortedReplies.slice(0, 3);
            
            topReplies.forEach(reply => {
              cardContent += `
                <div class="d-flex mb-3">
                  <img src="${reply.profilePicture || 'https://via.placeholder.com/30'}" class="rounded-circle mr-2" width="30" height="30">
                  <div class="w-100">
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <span class="font-weight-bold">${reply.handle}</span>
                        ${reply.verified ? '<i class="fas fa-check-circle text-primary"></i>' : ''}
                        <span class="text-muted small ml-2">${formatDate(reply.timestamp)}</span>
                      </div>
                    </div>
                    <p class="mb-1">${reply.text}</p>
                    <div>
                      <button class="btn btn-sm btn-link text-muted reply-like-btn ${reply.likes > 0 ? 'liked' : ''}" data-tweet-id="${tweet.id}" data-reply-id="${reply.id}" data-likes="${reply.likes}">
                        <i class="${reply.likes > 0 ? 'fas' : 'far'} fa-heart"></i> ${reply.likes}
                      </button>
                    </div>
                  </div>
                </div>
              `;
            });
            
            // Show 'Show more replies' if there are more than 3
            if (tweet.replies.length > 3) {
              cardContent += `
                <button class="btn btn-link btn-sm text-muted">Show ${tweet.replies.length - 3} more ${tweet.replies.length - 3 === 1 ? 'reply' : 'replies'}</button>
              `;
            }
            
            cardContent += `</div>`;
          }
          
          // Set the card content
          tweetCard.innerHTML = cardContent;
          
          // Add the tweet card to the container
          tweetsContainer.appendChild(tweetCard);
        });
        
        // Set up event listeners for actions
        setupActionButtons();
        
        console.log('All tweets rendered');
        setupQuoteButtons(); // Set up quote buttons after rendering tweets
      } catch (error) {
        console.error('Error loading tweets:', error);
      }
    }
    
    // Call loadTweets when the page loads
    document.addEventListener('DOMContentLoaded', () => {
      checkAuth();
      loadTrending();
      loadTweets();
    });
  </script>
  
  <!-- Add Quote Tweet Modal -->
  <div class="modal fade" id="quoteModal" tabindex="-1" role="dialog" aria-labelledby="quoteModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="quoteModalLabel">Quote Tweet</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div id="quotedTweetContainer" class="p-3 mb-3 border rounded">
            <!-- Quoted tweet will be displayed here -->
          </div>
          <div class="form-group">
            <textarea class="form-control" id="quoteText" rows="3" placeholder="Add a comment"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="submitQuote">Quote</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Add quote tweet functionality
    let currentQuotedTweet = null;

    function setupQuoteButtons() {
      document.querySelectorAll('.quote-btn').forEach(button => {
        button.addEventListener('click', function(event) {
          event.preventDefault();
          event.stopPropagation();
          
          const tweetCard = this.closest('.tweet-card');
          const tweetId = parseInt(tweetCard.dataset.tweetId);
          
          // Find the tweet data
          const tweet = window.allTweets.find(t => t.id === tweetId);
          if (!tweet) return;
          
          // Store the tweet to be quoted
          currentQuotedTweet = {
            id: tweet.id,
            handle: tweet.handle,
            text: tweet.text,
            timestamp: tweet.timestamp,
            verified: tweet.verified
          };
          
          // Display the tweet in the modal
          const quotedTweetContainer = document.getElementById('quotedTweetContainer');
          quotedTweetContainer.innerHTML = `
            <div class="d-flex">
              <div class="mr-2">
                <img src="${tweet.profilePicture || 'https://via.placeholder.com/50'}" class="rounded-circle" width="30">
              </div>
              <div>
                <div class="font-weight-bold">
                  ${tweet.handle} ${tweet.verified ? '<i class="fas fa-check-circle text-primary"></i>' : ''}
                </div>
                <div>${tweet.text}</div>
              </div>
            </div>
          `;
          
          // Show the modal
          $('#quoteModal').modal('show');
        });
      });
    }
    
    // Handle the quote submission
    document.getElementById('submitQuote').addEventListener('click', async function() {
      if (!currentQuotedTweet) return;
      
      const text = document.getElementById('quoteText').value;
      const currentUser = localStorage.getItem('currentUser');
      
      if (!currentUser) {
        alert('You must be logged in to quote a tweet');
        return;
      }
      
      try {
        const response = await fetch('/api/tweet', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            handle: currentUser,
            text: text,
            quotedTweet: currentQuotedTweet
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Close the modal
          $('#quoteModal').modal('hide');
          
          // Clear the form
          document.getElementById('quoteText').value = '';
          currentQuotedTweet = null;
          
          // Refresh tweets
          loadTweets();
        } else {
          alert('Error posting quote: ' + data.error);
        }
      } catch (error) {
        console.error('Error posting quote:', error);
        alert('Error posting quote: ' + error.message);
      }
    });
  </script>
  
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Public Service Announcement Panel -->
  <div class="card mt-3 mb-3" id="psa-panel">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Public Service Announcement from Devs</h5>
      <button type="button" class="close text-white" id="psa-close-btn" aria-label="Close">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
    <div class="card-body">
      <p class="card-text">I have made the difficult decision to conclude development of Mock Twitter. There will still be bug fixes but for a while, no new big features. no the home button will not work.</p>
    </div>
  </div>

  <script>
    // Add event listener for PSA close button
    document.addEventListener('DOMContentLoaded', () => {
      const psaCloseBtn = document.getElementById('psa-close-btn');
      const psaPanel = document.getElementById('psa-panel');
      
      if (psaCloseBtn && psaPanel) {
        psaCloseBtn.addEventListener('click', () => {
          psaPanel.style.display = 'none';
        });
      }
    });
  </script>
</body>
</html>

